<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç”Ÿæ—¥å¿«æ¨‚ï½œå…Œæ›åˆ¸</title>
    <meta name="description" content="ç°¡æ½”é¢¨æ ¼çš„ç”Ÿæ—¥ç¥ç¦é é¢ï¼Œå«å¯ç”±ç™¼åˆ¸è€…æ ¸éŠ·çš„å…Œæ›åˆ¸ç‹€æ…‹ã€‚" />
    <style>
        :root {
            --mint: #BFF1DD;
            /* è–„è·ç¶ ï¼ˆè¼”åŠ©è‰²ï¼‰ */
            --mint-deep: #7BD4B2;
            /* æ·±ä¸€éšè–„è· */
            --ink: #1F2937;
            /* æ·±ç°æ–‡å­— */
            --paper: #ffffff;
            /* ç™½ï¼ˆåº•è‰²ï¼‰ */
            --line: #E5F5EE;
            /* æ·ºç¶ é‚Šç·š */
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans TC", "PingFang TC", "Heiti TC", sans-serif;
            color: var(--ink);
            background: var(--paper);
        }

        .wrap {
            max-width: 780px;
            margin: 0 auto;
            padding: 24px;
        }

        .card {
            background: var(--paper);
            border: 1px solid var(--line);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .04);
        }

        h1 {
            margin: 0 0 8px;
            font-size: 28px;
            letter-spacing: .5px;
        }

        .subtitle {
            margin: 0 0 20px;
            color: #4B5563
        }

        .coupon {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 999px;
            padding: 6px 12px;
            font-weight: 600;
        }

        .badge.open {
            background: #ECFDF5;
            color: #065F46;
            border: 1px solid #A7F3D0
        }

        .badge.closed {
            background: #FEF2F2;
            color: #991B1B;
            border: 1px solid #FECACA
        }

        .muted {
            color: #6B7280;
            font-size: 14px
        }

        .title {
            font-weight: 700;
            font-size: 22px
        }

        .btn {
            cursor: pointer;
            border: 1px solid transparent;
            background: var(--mint-deep);
            color: #064E3B;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 700;
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .btn.secondary {
            background: #F3FFF9;
            border-color: #CFF4E3;
            color: #065F46
        }

        .btn.ghost {
            background: transparent;
            border-color: #CDEFE2;
            color: #065F46
        }

        .kv {
            display: grid;
            grid-template-columns: 110px 1fr;
            gap: 8px;
        }

        .kv div {
            padding: 6px 0;
            border-bottom: 1px dashed #E5E7EB
        }

        .hint {
            font-size: 12px;
            color: #6B7280
        }

        .hr {
            height: 1px;
            background: #E5E7EB;
            margin: 16px 0
        }

        dialog {
            border: none;
            border-radius: 16px;
            padding: 0;
            width: min(460px, 92vw);
        }

        dialog .sheet {
            padding: 20px
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, .25)
        }

        input,
        .input {
            width: 100%;
            border: 1px solid #D1FAE5;
            background: #F8FFFC;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 16px;
            color: #064E3B
        }

        code {
            background: #F1F5F9;
            padding: 2px 6px;
            border-radius: 6px
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h1>ç”Ÿæ—¥å¿«æ¨‚ï¼Œ<span id="name"></span>ï¼</h1>
            <p class="subtitle" id="customMsg"></p>

            <div class="coupon">
                <div class="row">
                    <div class="title">ğŸ½ï¸ å…Œæ›åˆ¸</div>
                    <div id="statusBadge" class="badge open">æœªå…Œæ›</div>
                </div>
                <div class="kv">
                    <div class="muted">æ”¶ä»¶äºº</div>
                    <div id="kvRecipient"></div>
                    <div class="muted">å…§å®¹</div>
                    <div>ä¸€èµ·åƒä¸€é “å–œæ­¡çš„é¤é»ï¼ˆæˆ‘è«‹å®¢ï¼‰</div>
                    <div class="muted">æœ‰æ•ˆæœŸé™</div>
                    <div id="kvExpiry"></div>
                    <div class="muted">åˆ¸ç·¨è™Ÿ</div>
                    <div id="kvId"></div>
                    <div class="muted">ç‹€æ…‹</div>
                    <div id="kvState">æœªå…Œæ›</div>
                    <div class="muted">æ ¸éŠ·æ™‚é–“</div>
                    <div id="kvRedeemedAt">â€”</div>
                </div>
                <div class="row">
                    <button id="btnHow" class="btn secondary">ä½¿ç”¨èªªæ˜</button>
                    <div class="row" style="gap:8px">
                        <button id="btnAdmin" class="btn">æ ¸éŠ·ï¼ˆç®¡ç†å“¡ï¼‰</button>
                        <button id="btnCopy" class="btn ghost" title="è¤‡è£½é€£çµ">è¤‡è£½é€£çµ</button>
                    </div>
                </div>
                <p class="hint">æç¤ºï¼šå—è´ˆäººåªéœ€ä¿å­˜æ­¤é€£çµã€‚æ ¸éŠ·åƒ…èƒ½ç”±ç™¼åˆ¸è€…åœ¨ç¾å ´å®Œæˆã€‚</p>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨èªªæ˜ -->
    <dialog id="dlgHow">
        <div class="sheet">
            <h3 style="margin:0 0 10px">å¦‚ä½•ä½¿ç”¨</h3>
            <ol style="margin:0 0 12px 18px; line-height:1.7">
                <li>æŠŠæœ¬é é€£çµå‚³çµ¦å£½æ˜Ÿä¿å­˜ã€‚</li>
                <li>å“ªå¤©è¦ç”¨åˆ¸ï¼Œåˆ°ç¾å ´å¾Œç”±ä½ é»ã€Œæ ¸éŠ·ï¼ˆç®¡ç†å“¡ï¼‰ã€â†’ è¼¸å…¥ç®¡ç† PINã€‚</li>
                <li>æˆåŠŸæ ¸éŠ·å¾Œï¼Œé é¢æœƒé¡¯ç¤ºã€Œå·²å…Œæ›ã€å’Œæ™‚é–“æˆ³è¨˜ã€‚</li>
            </ol>
            <div class="row" style="justify-content:flex-end; margin-top:8px">
                <button class="btn" id="closeHow">é—œé–‰</button>
            </div>
        </div>
    </dialog>

    <!-- ç®¡ç†å“¡æ ¸éŠ· -->
    <dialog id="dlgAdmin">
        <div class="sheet">
            <h3 style="margin:0 0 4px">æ ¸éŠ·ï¼ˆç®¡ç†å“¡ï¼‰</h3>
            <p class="muted" style="margin:0 0 12px">è¼¸å…¥ 6 ä½æ•¸ç®¡ç† PIN ä»¥æ¨™è¨˜æœ¬åˆ¸ç‚ºã€Œå·²å…Œæ›ã€ã€‚</p>
            <input id="pinInput" inputmode="numeric" maxlength="6" placeholder="ä¾‹å¦‚ï¼š123456" />
            <label style="display:flex; align-items:center; gap:8px; margin:12px 0 0">
                <input type="checkbox" id="cbConfirm" /> æˆ‘ç¢ºèªä»Šå¤©èˆ‡æŒåˆ¸äººå·²å®Œæˆç”¨é¤ã€‚
            </label>
            <div class="hr"></div>
            <div class="row" style="justify-content:flex-end">
                <button class="btn ghost" id="btnCancel">å–æ¶ˆ</button>
                <button class="btn" id="btnRedeem">æ ¸éŠ·</button>
            </div>
        </div>
    </dialog>

    <script>
        // â€”â€” åŸºæœ¬è¨­å®šï¼ˆä½ å¯ä»¥åœ¨é€™è£¡æ”¹åå­—æˆ–æœŸé™ï¼‰ â€”â€”
        const CONFIG = {
            recipientName: 'æ¥Šå¿ƒå¦®', // å—è´ˆäººå§“å
            expiry: '2026-08-14',    // æœ‰æ•ˆæœŸé™ï¼ˆYYYY-MM-DDï¼‰
            couponId: 'coupon-0814', // åˆ¸ç·¨è™Ÿ
            adminPIN: '900814',      // âœ… æ ¸éŠ· PINï¼ˆä½ æŒ‡å®šçš„æ•¸å­—ï¼‰
            customMessage: 'è€å§ï¼Œç”Ÿæ—¥å¿«æ¨‚ï¼æƒ³åƒé£¯å°±ç´„æˆ‘ï¼Œé€™è£¡æœ‰ä¸€å¼µ ã€Œè«‹ä½ åƒé£¯ã€ çš„å…Œæ›åˆ¸ï¼Œä¸‹æ¬¡è¦‹é¢å†è«‹ä½ åƒé£¯ã€‚é †ä¾¿å¸¶æˆ‘å¥³æœ‹å‹è·Ÿä½ èªè­˜èªè­˜å•¦å“ˆå“ˆå“ˆï¼'
        };

        // â€”â€” DOM ç¶å®š â€”â€”
        const $ = (s) => document.querySelector(s);
        const nameEl = $('#name');
        const msgEl = $('#customMsg');
        const kvRecipient = $('#kvRecipient');
        const kvExpiry = $('#kvExpiry');
        const kvId = $('#kvId');
        const kvState = $('#kvState');
        const kvRedeemedAt = $('#kvRedeemedAt');
        const statusBadge = $('#statusBadge');

        const dlgAdmin = $('#dlgAdmin');
        const pinInput = $('#pinInput');
        const btnRedeem = $('#btnRedeem');
        const cbConfirm = $('#cbConfirm');

        const dlgHow = $('#dlgHow');

        // â€”â€” è³‡æ–™å±¤ï¼ˆåƒ…æœ¬æ©Ÿå„²å­˜ï¼‰ â€”â€”
        const STORAGE_KEY = `meal-coupon::${CONFIG.couponId}`;
        /** @type {{state:'open'|'redeemed', redeemedAt?:string, couponId:string}} */
        let coupon = { state: 'open', couponId: CONFIG.couponId };

        function init() {
            // åŸºæœ¬æ–‡æ¡ˆ
            nameEl.textContent = CONFIG.recipientName;
            msgEl.textContent = CONFIG.customMessage;
            kvRecipient.textContent = CONFIG.recipientName;
            kvExpiry.textContent = fmtDate(CONFIG.expiry);
            kvId.textContent = CONFIG.couponId;

            // è®€å–æœ¬æ©Ÿç‹€æ…‹
            const local = readLocal();
            if (local) { coupon = local; }
            render();
        }

        function readLocal() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch { return null }
        }
        function writeLocal(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

        function render() {
            const redeemed = coupon.state === 'redeemed';
            kvState.textContent = redeemed ? 'å·²å…Œæ›' : 'æœªå…Œæ›';
            statusBadge.textContent = redeemed ? 'å·²å…Œæ›' : 'æœªå…Œæ›';
            statusBadge.className = `badge ${redeemed ? 'closed' : 'open'}`;
            kvRedeemedAt.textContent = redeemed ? fmtDateTime(coupon.redeemedAt) : 'â€”';
            btnRedeem.disabled = redeemed;
        }

        function redeem() {
            coupon.state = 'redeemed';
            coupon.redeemedAt = new Date().toISOString();
            writeLocal(coupon);
            render();
        }

        // â€”â€” å·¥å…· â€”â€”
        function fmtDate(s) {
            const d = new Date(s);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${y}/${m}/${dd}`;
        }
        function fmtDateTime(s) {
            if (!s) return 'â€”';
            const d = new Date(s);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            return `${y}/${m}/${dd} ${hh}:${mm}`;
        }

        // â€”â€” äº‹ä»¶ â€”â€”
        $('#btnAdmin').addEventListener('click', () => {
            if (coupon.state === 'redeemed') return alert('æ­¤åˆ¸å·²è¢«æ ¸éŠ·ã€‚');
            pinInput.value = '';
            cbConfirm.checked = false;
            dlgAdmin.showModal();
            setTimeout(() => pinInput.focus(), 50);
        });
        $('#btnCancel').addEventListener('click', () => dlgAdmin.close());

        btnRedeem.addEventListener('click', () => {
            const pin = pinInput.value.trim();
            if (pin.length !== 6) return alert('è«‹è¼¸å…¥ 6 ä½æ•¸ PIN');
            if (pin !== CONFIG.adminPIN) return alert('PIN ä¸æ­£ç¢º');
            if (!cbConfirm.checked) return alert('è«‹å‹¾é¸ç¢ºèªç”¨é¤');
            redeem();
            dlgAdmin.close();
            alert('å·²æ ¸éŠ·ï¼ç¥ç”¨é¤æ„‰å¿«ï¼');
        });

        $('#btnHow').addEventListener('click', () => dlgHow.showModal());
        $('#closeHow').addEventListener('click', () => dlgHow.close());

        $('#btnCopy').addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(location.href);
                alert('å·²è¤‡è£½é€£çµ');
            } catch { alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç¶²å€åˆ—'); }
        });

        // å•Ÿå‹•
        init();
    </script>
</body>

</html>