<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é…’ç²¾å¤§å¯Œç¿ â€” v10</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    :root { --bg:#0f1116;--panel:#151a22;--tile:#1c2330;--text:#e6f0ff;--muted:#a9b6cc;--accent:#8ac6ff;
      --c-start:#F6C549; --b-start:#7a5a00; --g-start:linear-gradient(180deg,#6b4c00,#2a2209);
      --c-chance:#3FC3FF; --b-chance:#1777a6; --g-chance:linear-gradient(180deg,#0d3960,#0a2238);
      --c-destiny:#FF7CD6; --b-destiny:#a63a85; --g-destiny:linear-gradient(180deg,#4a1038,#2c0f24);
      --c-shot:#FF975B; --b-shot:#a2481e; --g-shot:linear-gradient(180deg,#4a1906,#2a0e03);
      --c-beer:#57E27A; --b-beer:#218c44; --g-beer:linear-gradient(180deg,#144d2b,#0d2816);
      --c-danger:#FF5E5E; --b-danger:#a33a3a; --g-danger:linear-gradient(180deg,#4a1010,#2a0808);
    }
    html,body{height:100%;margin:0;background:#0e1420;color:var(--text);font-family:ui-sans-serif,system-ui,"Segoe UI",Noto Sans,Arial;overflow:auto}
    body.host-mode{overflow:hidden}

    .app{min-height:100%;display:grid;grid-template-rows:56px 1fr;gap:8px;padding:10px}
    body.host-mode .app{height:100vh}
    .top{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border-radius:12px;padding:0 10px}
    .top .row{flex-wrap:wrap;justify-content:flex-end}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .btn{background:#203049;border:1px solid #2e4161;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:320px 1fr 320px;grid-template-rows:1fr;gap:10px;min-height:0}
    body.host-mode .grid{height:100%}
    .pane{background:var(--panel);border-radius:12px;padding:10px;overflow:auto;min-height:0}
    body.host-mode .pane{overflow:hidden}
    body.host-mode #playersPane{display:flex;flex-direction:column;gap:10px}
    body.host-mode #playersPane > .card{flex-shrink:0}
    body.host-mode #playerList{flex:1;overflow:auto;min-height:0;padding-right:6px}
    .title{font-size:12px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;margin-bottom:6px}
    .card{border:1px solid #324666;border-radius:12px;padding:10px;background:#0f1522}
    .list{display:grid;gap:8px}
    .row{display:flex;gap:8px;align-items:center}
    .player-head{align-items:center;gap:10px}
    .player-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.2);box-shadow:0 0 0 2px rgba(0,0,0,.35)}
    .player-dot{width:16px;height:16px;border-radius:999px;border:2px solid rgba(255,255,255,.7)}
    .remote-tag{font-size:11px;color:var(--accent);margin-left:auto}
    .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .card-header .title{margin-bottom:0}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.25)}
    .btn.danger{background:#9d2d2d;border-color:#c45353}
    .remote-info{display:grid;gap:8px;text-align:center}
    #remoteJoinCard .collapse-hint{display:none;font-size:13px;color:var(--muted);margin-bottom:6px;cursor:pointer}
    #remoteJoinCard.collapsed .remote-info{display:none}
    #remoteJoinCard.collapsed .collapse-hint{display:block}
    .remote-info canvas{margin:0 auto;border-radius:12px;background:#fff;padding:10px}
    .link{color:var(--accent);word-break:break-all}
    .copy-btn{align-self:center}

    .client-pane{display:none;gap:10px;grid-template-columns:1fr;margin-bottom:20px}
    .client-pane .card{background:rgba(15,22,36,.9)}
    .client-status{font-size:14px}
    .client-message{font-size:13px;color:var(--muted)}

    .client-list{display:grid;gap:6px}
    .client-list .item{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:10px;background:rgba(26,36,56,.6)}
    .client-list .item .player-avatar{width:32px;height:32px}
    input,select,textarea{background:#0f1624;border:1px solid #2c3f60;color:var(--text);border-radius:10px;padding:8px}

    .client-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;background:rgba(0,0,0,.65);z-index:70}
    .client-overlay .box{width:min(480px,94vw);background:rgba(15,22,36,.94);border:1px solid #2e4161;border-radius:14px;padding:16px;display:grid;gap:12px}
    .client-overlay .hint{color:var(--muted);font-size:13px}
    .client-overlay .face{border:0;background:transparent}

    .meter{background:#0b1220;border-radius:8px;border:1px solid #2b3952;height:8px;width:120px;position:relative;overflow:hidden}
    .meter span{position:absolute;inset:0;width:0;background:linear-gradient(90deg,#77c6ff,#b282ff)}

    .board-wrap{position:relative;display:grid;place-items:center;height:100%}
    .board{--N:8;width:min(94vh,calc(100% - 24px));aspect-ratio:1/1;display:grid;grid-template-columns:repeat(var(--N),1fr);grid-template-rows:repeat(var(--N),1fr);gap:6px;background:#0c1220;padding:6px;border-radius:18px;border:1px solid #2b3750;box-shadow:inset 0 0 60px rgba(0,0,0,.35)}
    .ghost{border:1px dashed rgba(255,255,255,.06);border-radius:12px}

    .tile{background:var(--tile);border:2px solid #2b3952;border-radius:12px;display:grid;place-items:center;text-align:center;padding:6px;font-size:12px;line-height:1.15;position:relative;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .tile .tag{position:absolute;top:6px;left:6px;font-size:10px;padding:2px 6px;border-radius:999px;background:#0e1522;border:1px solid #263550;color:var(--muted)}

    .tile.start{background:var(--g-start);border-color:var(--b-start)}
    .tile.start:after{content:"";position:absolute;inset:auto 6px 6px 6px;height:4px;background:var(--c-start);border-radius:4px}
    .tile.chance{background:var(--g-chance);border-color:var(--b-chance)}
    .tile.chance:after{content:"";position:absolute;inset:auto 6px 6px 6px;height:4px;background:var(--c-chance);border-radius:4px}
    .tile.destiny{background:var(--g-destiny);border-color:var(--b-destiny)}
    .tile.destiny:after{content:"";position:absolute;inset:auto 6px 6px 6px;height:4px;background:var(--c-destiny);border-radius:4px}
    .tile.shot{background:var(--g-shot);border-color:var(--b-shot)}
    .tile.shot:after{content:"";position:absolute;inset:auto 6px 6px 6px;height:4px;background:var(--c-shot);border-radius:4px}
    .tile.beer{background:var(--g-beer);border-color:var(--b-beer)}
    .tile.beer:after{content:"";position:absolute;inset:auto 6px 6px 6px;height:4px;background:var(--c-beer);border-radius:4px}
    .tile.danger{background:var(--g-danger);border-color:var(--b-danger)}
    .tile.danger:after{content:"";position:absolute;inset:auto 6px 6px 6px;height:4px;background:var(--c-danger);border-radius:4px}

    .center{display:grid;place-items:center;overflow:auto}
    .table{position:absolute;inset:16% 16%;border-radius:18px;border:1px dashed #33425e;display:grid;place-items:center;padding:10px;color:var(--muted)}
    .brandmark{font-weight:900;font-size:28px;letter-spacing:2px}
    .slogan{font-size:12px;color:var(--muted);margin-top:6px}

    .pawn{position:absolute;width:24px;height:24px;border-radius:999px;border:3px solid #fff;box-sizing:content-box;transform:translate(-50%,-50%);transition:transform .3s ease;z-index:10;overflow:hidden;display:grid;place-items:center;background:#fff}
    .pawn.has-avatar{border-color:rgba(255,255,255,.7);background:#0f1624}
    .pawn img{width:100%;height:100%;object-fit:cover;border-radius:50%}
    .active{outline:2px solid var(--accent);box-shadow:0 0 0 4px rgba(138,198,255,.15)}

    .hud{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:60}
    .hud .panel{display:grid;gap:8px;background:rgba(18,26,42,.85);backdrop-filter:blur(6px);border:1px solid #354765;border-radius:14px;padding:10px}
    .hud .row{display:flex;gap:8px;align-items:center}
    .hint{font-size:12px;color:var(--muted)}

    .dice{width:48px;height:48px;border-radius:12px;background:#0f1624;border:1px solid #2c3b52;display:grid;place-items:center;font-weight:800;font-size:22px}
    .dice.spin{animation:spin .7s ease-in-out infinite}
    @keyframes spin{0%{transform:rotate(0)}50%{transform:rotate(15deg)}100%{transform:rotate(-15deg)}}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .box{width:min(720px,96vw);max-height:90vh;overflow:auto;background:#121a2a;border:1px solid #354765;border-radius:14px;padding:14px}
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{border:1px solid #2c3f60;padding:6px 8px;font-size:14px}
    .tbl th{position:sticky;top:0;background:#101827}
    .flip{perspective:1000px}
    .flip-inner{position:relative;width:100%;min-height:180px;transform-style:preserve-3d;transition:transform .5s ease}
    .flip.flipped .flip-inner{transform:rotateY(180deg)}
    .face{position:absolute;inset:0;padding:14px;border-radius:12px;border:1px solid #2e4161;background:#0f1624;backface-visibility:hidden}
    .back{transform:rotateY(180deg)}

    /* æ”¾å¤§ç¿»å¡å­—é«” */
    #tileDesc{font-size:18px;line-height:1.7}
    #cardText{font-size:22px;line-height:1.6}

    .client-mode .top .row{display:none}
    .client-mode .grid,.client-mode .hud,.client-mode #remoteJoinCard{display:none}
    .client-mode .app{grid-template-rows:auto 1fr;padding:16px}
    .client-mode .client-pane{display:grid}

    @media (max-width:1200px){
      .grid{grid-template-columns:1fr;grid-template-rows:auto auto auto}
      .hud{position:static;right:auto;bottom:auto}
      .app{grid-template-rows:auto auto 1fr}
      body.host-mode{overflow:auto}
      body.host-mode .app{height:auto}
      body.host-mode .pane{overflow:auto}
      body.host-mode #playersPane{display:block}
      body.host-mode #playerList{overflow:visible;padding-right:0}
    }
    @media (max-width:900px){
      .board{width:100%;max-width:100%;aspect-ratio:1/1}
      .board-wrap{padding-bottom:20px}
    }
    @media (max-width:768px){
      .top{flex-direction:column;align-items:flex-start;padding:10px;gap:8px}
      .top .row{width:100%;justify-content:flex-start}
      .hud{width:100%}
      .hud .panel{width:100%}
      .app{gap:12px;padding:12px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">ğŸ» é…’ç²¾å¤§å¯Œç¿ Â· v10</div>
      <div class="row">
        <button class="btn" id="btnEditor">æª¢è¦– / ç·¨è¼¯ äº‹ä»¶èˆ‡å¡ç‰Œ</button>
        <button class="btn" id="btnSaveCfg">å°å‡ºè¨­å®š</button>
        <input id="cfgFile" type="file" hidden accept="application/json">
        <button class="btn" id="btnLoadCfg">è¼‰å…¥è¨­å®š</button>
        <button class="btn" id="btnReset">é‡é–‹æ–°å±€</button>
        <button class="btn" id="btnHow">å¿«é€Ÿèªªæ˜</button>
      </div>
    </div>

    <div class="grid">
      <div class="pane" id="playersPane">
        <div class="title">ç©å®¶</div>
        <div class="card">
          <div class="row"><input id="playerName" placeholder="ç©å®¶åç¨±ï¼Œä¾‹å¦‚ï¼šå°æ˜"><button class="btn" id="addPlayer">åŠ å…¥</button></div>
          <div class="row"><button class="btn" id="quick2">å¿«é€Ÿ 2 äºº</button><button class="btn" id="quick4">å¿«é€Ÿ 4 äºº</button></div>
        </div>
        <div class="card" id="remoteJoinCard">
          <div class="card-header">
            <div class="title">æ‰‹æ©ŸåŠ å…¥</div>
            <button class="btn ghost" id="remoteJoinToggle" type="button">ç¸®å°</button>
          </div>
          <div class="collapse-hint" id="remoteCollapsedHint">å·²æ”¶åˆï¼Œé»æ“Šã€Œå±•é–‹ã€é¡¯ç¤º QR Code èˆ‡åŠ å…¥é€£çµ</div>
          <div class="remote-info" id="remoteJoinContent">
            <div>æˆ¿é–“ä»£ç¢¼ï¼š<b id="roomCode">â€”</b></div>
            <canvas id="joinQR" width="200" height="200"></canvas>
            <a class="link" id="joinUrl" target="_blank" rel="noopener"></a>
            <button class="btn copy-btn" id="copyJoinLink" type="button">è¤‡è£½é€£çµ</button>
            <div class="hint" id="remoteStatus">è¡Œå‹•åŠ å…¥åŠŸèƒ½æº–å‚™ä¸­â€¦</div>
          </div>
        </div>
        <div class="list" id="playerList"></div>
      </div>

      <div class="pane center">
        <div class="board-wrap">
          <div class="board" id="board"></div>
          <div class="table">
            <div class="brandmark">é…’ç²¾å¤§å¯Œç¿</div>
            <div class="slogan">è«‹ç†æ€§é£²é…’ Â· éŠæˆ²æ„‰å¿«</div>
          </div>
        </div>
      </div>

      <div class="pane">
        <div class="title">è³‡è¨Š</div>
        <div class="list">
          <div class="card"><div class="title">ç›®å‰ç©å®¶</div><div>åç¨±ï¼š<b id="turnName">â€”</b> Â· ä½ç½® <span id="turnPos">0</span></div></div>
          <div class="card"><div class="title">å¡ç‰Œå€</div><div>Chanceï¼š<span id="chancePeek"></span> Â· Destinyï¼š<span id="destinyPeek"></span></div></div>
          <div class="card"><div class="title">éŠæˆ²å¡æ± </div><div>Gamesï¼š<span id="gamePeek"></span></div></div>
          <div class="card"><div class="title">äº‹ä»¶ç´€éŒ„</div><div class="log" id="log" style="max-height:40vh;overflow:auto;display:grid;gap:8px"></div></div>
        </div>
      </div>
    </div>

    <div class="client-pane" id="clientPanel">
      <div class="card">
        <div class="title">é€£ç·šç‹€æ…‹</div>
        <div class="client-status" id="clientStatusText">ç­‰å¾…é€£ç·šâ€¦</div>
        <div class="client-message" id="clientMessage"></div>
        <div class="hint">æˆ¿é–“ä»£ç¢¼ï¼š<b id="clientRoomCode">â€”</b></div>
      </div>
      <div class="card" id="clientJoinCard">
        <div class="title">åŠ å…¥éŠæˆ²</div>
        <div class="list">
          <input id="clientName" placeholder="è¼¸å…¥æš±ç¨±">
          <input type="file" id="clientAvatar" accept="image/*">
          <button class="btn" id="clientJoinBtn" type="button">åŠ å…¥</button>
        </div>
        <div class="hint">å¯ä¸Šå‚³å€‹äººå¤§é ­è²¼ï¼ˆå»ºè­°å°æ–¼ 5 MBï¼‰ã€‚</div>
      </div>
      <div class="card" id="clientAdminCard">
        <div class="title">ç®¡ç†å“¡ç™»å…¥</div>
        <div class="list">
          <input type="password" id="clientAdminPassword" placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼">
          <button class="btn" id="clientAdminLoginBtn" type="button">ç™»å…¥ç®¡ç†å“¡</button>
        </div>
        <div class="hint" id="clientAdminStatus">åƒ…ä¾›é–‹ç™¼è€…ç¶­è­·ä½¿ç”¨ã€‚</div>
      </div>
      <div class="card" id="clientAdminControls" style="display:none">
        <div class="title">ç®¡ç†å“¡æ§åˆ¶å°</div>
        <div class="list">
          <div class="row" style="flex-wrap:wrap;gap:8px">
            <button class="btn" data-admin-action="roll" type="button">æ“²éª°</button>
            <button class="btn" data-admin-action="endTurn" type="button">çµæŸå›åˆ</button>
            <button class="btn" data-admin-action="undo" type="button">å›ä¸Šä¸€æ­¥</button>
          </div>
          <label class="row" style="gap:8px;align-items:center">
            <input type="checkbox" id="clientAdminAutoNext">
            è‡ªå‹•æ›äºº
          </label>
          <button class="btn danger" data-admin-action="reset" type="button">é‡æ–°é–‹å±€</button>
        </div>
      </div>
      <div class="card" id="clientControls" style="display:none">
        <div class="title">è¡Œå‹•æ“æ§</div>
        <div class="list">
          <div>è¼ªåˆ°ï¼š<b id="clientTurnName">â€”</b></div>
          <div>ä½ ç›®å‰ä½ç½®ï¼š<span id="clientPos">â€”</span></div>
          <div class="row" style="flex-wrap:wrap;gap:10px">
            <button class="btn" id="clientRollBtn" type="button" disabled>æ“²éª°</button>
            <button class="btn" id="clientEndBtn" type="button" disabled>çµæŸå›åˆ</button>
          </div>
          <div id="clientDiceInfo">éª°å­ï¼šâ€”</div>
        </div>
      </div>
      <div class="card" id="clientPlayersCard" style="display:none">
        <div class="title">ç©å®¶</div>
        <div class="client-list" id="clientPlayers"></div>
      </div>
      <div class="card" id="clientLogCard" style="display:none">
        <div class="title">æœ€æ–°äº‹ä»¶</div>
        <div class="list" id="clientLog"></div>
      </div>
    </div>

    <div class="client-overlay" id="clientTileModal">
      <div class="box">
        <div class="flip" id="clientTileFlip">
          <div class="flip-inner">
            <div class="face front">
              <div class="row" style="justify-content:space-between;align-items:center">
                <div class="title">ä½ åœåœ¨</div>
                <button class="btn" id="clientTileFlipBtn" type="button">ç¿»é–‹å…§å®¹</button>
              </div>
              <h2 id="clientTileTitle" style="margin:6px 0 4px"></h2>
              <div class="card" id="clientTileType" style="display:inline-block"></div>
              <div class="hint" id="clientTileHint"></div>
            </div>
            <div class="face back">
              <div class="title">è¦å‰‡å…§å®¹</div>
              <div id="clientTileDesc" style="white-space:pre-wrap;"></div>
              <div class="hint" id="clientTileControllerHint"></div>
              <div class="row" style="margin-top:12px;justify-content:end"><button class="btn" id="clientTileOkBtn" type="button">äº†è§£ï¼ŒåŸ·è¡Œ</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="client-overlay" id="clientCardModal">
      <div class="box">
        <div class="flip" id="clientCardFlip">
          <div class="flip-inner">
            <div class="face front">
              <div class="row" style="justify-content:space-between;align-items:center">
                <div class="title" id="clientCardDeck">æŠ½å¡</div>
                <button class="btn" id="clientCardFlipBtn" type="button">ç¿»é–‹å¡ç‰Œ</button>
              </div>
              <h2 style="margin:6px 0 4px">ï¼Ÿï¼Ÿï¼Ÿ</h2>
              <div class="card hint">ç­‰å¾…ç¿»é–‹ä»¥æŸ¥çœ‹å…§å®¹</div>
            </div>
            <div class="face back">
              <div class="title">å¡ç‰Œå…§å®¹</div>
              <h3 id="clientCardText" style="margin:6px 0 8px"></h3>
              <div class="hint" id="clientCardHint">å¡ç‰Œæ•ˆæœå°‡ç«‹å³åŸ·è¡Œ</div>
              <div class="hint" id="clientCardControllerHint"></div>
              <div class="row" style="margin-top:12px;justify-content:end"><button class="btn" id="clientCardOkBtn" type="button">å¥½</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="hud">
      <div class="panel">
        <div class="row"><div class="dice" id="dice">â€“</div><button class="btn" id="roll">æ“²éª°</button><button class="btn" id="endTurn">çµæŸå›åˆ</button><button class="btn" id="undoBtn">å›ä¸Šä¸€æ­¥</button></div>
        <div class="row" style="justify-content:space-between">
          <label class="row"><input type="checkbox" id="autoNext"> è‡ªå‹•æ›äºº</label>
          <div class="hint" id="guardHint"></div>
        </div>
      </div>
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <a class="btn" id="btnExportSave" href="#">å°å‡ºå­˜æª”</a>
          <div class="row"><input type="file" id="importSave" hidden accept="application/json"><button class="btn" id="btnImportSave">è¼‰å…¥å­˜æª”</button></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯å™¨ Modal -->
  <div class="modal" id="modalEditor">
    <div class="box">
      <div class="row" style="justify-content:space-between"><div style="font-weight:700">æª¢è¦– / ç·¨è¼¯äº‹ä»¶èˆ‡å¡ç‰Œ</div><div class="row"><button class="btn" id="btnDefault">é‚„åŸé è¨­</button><button class="btn" id="btnClose">å®Œæˆä¸¦é—œé–‰</button></div></div>
      <div class="card"><div class="title">æ ¼å­ï¼ˆTilesï¼‰ <span id="tileCount" class="hint"></span></div>
        <table class="tbl" id="tblTiles"><thead><tr><th>#</th><th>æ¨™é¡Œ</th><th>type</th><th>æè¿°</th><th></th></tr></thead><tbody></tbody></table>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="addTile">æ–°å¢æ ¼å­</button>
          <button class="btn" id="pad28">ä¸€éµè£œæ»¿åˆ° 28 æ ¼</button>
          <span class="hint">ï¼ˆå¤–åœˆå›ºå®š 28 æ ¼ï¼Œä¸è¶³ä»¥ã€Œç©ºåœ°ã€è£œæ»¿ï¼›è¶…éåªå–å‰ 28ï¼‰</span>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <div class="card" style="flex:1"><div class="title">æ©Ÿæœƒï¼ˆChanceï¼‰</div><div class="list" id="chanceList"></div><div class="row"><button class="btn" id="addChance">æ–°å¢æ©Ÿæœƒå¡</button></div></div>
        <div class="card" style="flex:1"><div class="title">å‘½é‹ï¼ˆDestinyï¼‰</div><div class="list" id="destinyList"></div><div class="row"><button class="btn" id="addDestiny">æ–°å¢å‘½é‹å¡</button></div></div>
        <div class="card" style="flex:1"><div class="title">éŠæˆ²å¡ï¼ˆGamesï¼‰</div><div class="list" id="gameList"></div><div class="row"><button class="btn" id="addGame">æ–°å¢éŠæˆ²å¡</button></div></div>
      </div>
      <div class="card"><div class="title">è¨­å®šåŒ¯å…¥ / åŒ¯å‡º</div><div class="row"><button class="btn" id="btnExportCfg2">å°å‡º JSON</button><input type="file" id="importCfg2" hidden accept="application/json"><button class="btn" id="btnImportCfg2">è¼‰å…¥ JSON</button></div></div>
    </div>
  </div>

  <!-- åœæ ¼ç¿»å¡ Modal -->
  <div class="modal" id="modalTile">
    <div class="box">
      <div class="flip" id="flip">
        <div class="flip-inner">
          <div class="face front">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="title">ä½ åœåœ¨</div>
              <button class="btn" id="btnFlip">ç¿»é–‹å…§å®¹</button>
            </div>
            <h2 id="tileTitle" style="margin:6px 0 4px"></h2>
            <div class="card" id="tileType" style="display:inline-block"></div>
          </div>
          <div class="face back">
            <div class="title">è¦å‰‡å…§å®¹</div>
            <div id="tileDesc" style="white-space:pre-wrap;"></div>
            <div class="row" style="margin-top:12px;justify-content:end"><button class="btn" id="btnTileOk">äº†è§£ï¼ŒåŸ·è¡Œ</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æŠ½å¡ï¼ˆæ©Ÿæœƒ/å‘½é‹/éŠæˆ²ï¼‰Modal -->
  <div class="modal" id="modalCard">
    <div class="box">
      <div class="flip" id="flipCard">
        <div class="flip-inner">
          <div class="face front">
            <div class="row" style="justify-content:space-between;align-items:center"><div class="title" id="cardDeckTitle">æŠ½å¡</div><button class="btn" id="btnFlipCard">ç¿»é–‹å¡ç‰Œ</button></div>
            <h2 style="margin:6px 0 4px">ï¼Ÿï¼Ÿï¼Ÿ</h2>
            <div class="card hint">é»æ“Šç¿»é–‹ä»¥æŸ¥çœ‹å…§å®¹</div>
          </div>
          <div class="face back">
            <div class="title">å¡ç‰Œå…§å®¹</div>
            <h3 id="cardText" style="margin:6px 0 8px"></h3>
            <div id="cardHint" class="hint">å¡ç‰Œæ•ˆæœå°‡ç«‹å³åŸ·è¡Œ</div>
            <div class="row" style="margin-top:12px;justify-content:end"><button class="btn" id="btnCardOk">å¥½</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const el = (t,c,h)=>{const e=document.createElement(t); if(c) e.className=c; if(h!==undefined) e.innerHTML=h; return e};
    const sample = arr => arr[Math.floor(Math.random()*arr.length)];
    const params = new URLSearchParams(location.search);
    const joinCodeParam = params.get('join');
    const isClientMode = !!joinCodeParam;
    const isHostMode = !isClientMode;
    function safeRandomId(){
      if(window.crypto){
        if(typeof window.crypto.randomUUID==='function'){
          return window.crypto.randomUUID();
        }
        if(typeof window.crypto.getRandomValues==='function'){
          const bytes=new Uint8Array(16);
          window.crypto.getRandomValues(bytes);
          return Array.from(bytes).map((b,i)=>{
            const hex=b.toString(16).padStart(2,'0');
            if(i===6) return (parseInt(hex,16)&0x0f|0x40).toString(16).padStart(2,'0');
            if(i===8) return (parseInt(hex,16)&0x3f|0x80).toString(16).padStart(2,'0');
            return hex;
          }).join('').replace(/(.{8})(.{4})(.{4})(.{4})(.{12})/,'$1-$2-$3-$4-$5');
        }
      }
      return 'id-'+Math.random().toString(36).slice(2)+Date.now().toString(36);
    }
    if(isClientMode) document.body.classList.add('client-mode');
    if(isHostMode) document.body.classList.add('host-mode');
    let roomId = '';
    const peerConnections = new Set();
    const playerConnections = new Map();
    let peerInstance = null;
    let peerReady = false;
    const MAX_LOG_HISTORY = 60;
    const logHistory = [];
    const controlState = { tile:null, card:null };
    let pendingTileOnOk = null;
    let pendingCardOnDone = null;
    const clientContext = { peer:null, conn:null, joined:false, playerId:null, allowReconnect:true, lastProfile:null };
    const ADMIN_PASSWORD='980618';
    const adminConnections=new Set();
    let remoteStatusEl=null, joinUrlEl=null, roomCodeEl=null, joinQrCanvas=null, copyJoinBtn=null, remoteJoinCardEl=null, remoteJoinToggleBtn=null, remoteJoinContentEl=null, remoteCollapsedHintEl=null;
    let remoteJoinCollapsed=false;
    let clientStatusEl=null, clientMessageEl=null, clientJoinCardEl=null, clientControlsEl=null, clientPlayersEl=null, clientLogEl=null, clientRollBtn=null, clientEndBtn=null, clientTurnNameEl=null, clientPosEl=null, clientDiceInfoEl=null, clientPlayersCardEl=null, clientLogCardEl=null, clientJoinBtnEl=null, clientNameInputEl=null, clientAvatarInputEl=null;
    let clientTileModalEl=null, clientTileFlipWrapEl=null, clientTileFlipBtnEl=null, clientTileOkBtnEl=null, clientTileTitleEl=null, clientTileTypeEl=null, clientTileDescEl=null, clientTileHintEl=null, clientTileControllerHintEl=null;
    let clientCardModalEl=null, clientCardFlipWrapEl=null, clientCardFlipBtnEl=null, clientCardOkBtnEl=null, clientCardDeckEl=null, clientCardTextEl=null, clientCardHintEl=null, clientCardControllerHintEl=null;
    let clientAdminCardEl=null, clientAdminPasswordInputEl=null, clientAdminLoginBtnEl=null, clientAdminStatusEl=null, clientAdminControlsEl=null, clientAdminAutoNextEl=null;
    let clientAdminActionBtns=[];
    const clientAdminState={granted:false};
    let clientReconnectTimer=null;

    const ICE_SERVERS=[
      {urls:['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302','stun:stun2.l.google.com:19302','stun:stun3.l.google.com:19302']},
      {urls:'stun:stun4.l.google.com:19302'},
      {urls:'turn:openrelay.metered.ca:80',username:'openrelayproject',credential:'openrelayproject'},
      {urls:'turn:openrelay.metered.ca:443',username:'openrelayproject',credential:'openrelayproject'},
      {urls:'turn:openrelay.metered.ca:443?transport=tcp',username:'openrelayproject',credential:'openrelayproject'}
    ];
    const BASE_PEER_OPTIONS={host:'0.peerjs.com',port:443,secure:true,path:'/',debug:1,pingInterval:15000};
    function buildPeerOptions(extra={}){
      const {config:extraConfig={},...restExtra}=extra||{};
      const baseConfig={
        iceServers: ICE_SERVERS.map(server=>({
          ...server,
          urls: Array.isArray(server.urls)?[...server.urls]:server.urls
        })),
        iceTransportPolicy:'all'
      };
      return {
        ...BASE_PEER_OPTIONS,
        ...restExtra,
        config:{
          ...baseConfig,
          ...extraConfig
        }
      };
    }

    function generateRoomId(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }
    function normalizeRoomId(code){ return (code||'').toString().trim().toLowerCase(); }

    function updateRemoteStatus(){
      if(!remoteStatusEl) return;
      if(!peerInstance){ if(!remoteStatusEl.textContent) remoteStatusEl.textContent='è¡Œå‹•åŠ å…¥åŠŸèƒ½æº–å‚™ä¸­â€¦'; return; }
      const deviceCount = Array.from(peerConnections).filter(c=>c.open).length;
      const joinedCount = playerConnections.size;
      const adminCount = Array.from(adminConnections).filter(c=>c.open).length;
      remoteStatusEl.textContent = `å·²é€£ç·šè£ç½®ï¼š${deviceCount} Â· å·²åŠ å…¥ç©å®¶ï¼š${joinedCount} Â· ç®¡ç†å“¡ï¼š${adminCount}`;
    }

    function setRemoteJoinCollapsed(collapsed){
      remoteJoinCollapsed=!!collapsed;
      if(remoteJoinCardEl) remoteJoinCardEl.classList.toggle('collapsed',remoteJoinCollapsed);
      if(remoteJoinContentEl) remoteJoinContentEl.style.display=remoteJoinCollapsed?'none':'grid';
      if(remoteCollapsedHintEl) remoteCollapsedHintEl.style.display=remoteJoinCollapsed?'block':'none';
      if(remoteJoinToggleBtn) remoteJoinToggleBtn.textContent=remoteJoinCollapsed?'å±•é–‹':'ç¸®å°';
    }

    function getPublicState(){
      const active = state.players[state.turn] || null;
      return {
        roomId,
        players: state.players.map(p=>({id:p.id,name:p.name,color:p.color,pos:p.pos,totalSips:p.totalSips,skip:p.skip,avatar:p.avatar||null,remote:!!p.remote})),
        turn: state.turn,
        waitingEnd: state.waitingEnd,
        activePlayerId: active ? active.id : null,
        dice: ($('#dice')||{textContent:'â€“'}).textContent,
        logs: logHistory.slice(0,12),
        control: {
          tile: controlState.tile ? {...controlState.tile} : null,
          card: controlState.card ? {...controlState.card} : null
        },
        settings:{
          autoNext: !!($('#autoNext') && $('#autoNext').checked)
        }
      };
    }

    function broadcastState(){
      if(!isHostMode || !peerReady) return;
      const payload = { type:'state', payload:getPublicState() };
      peerConnections.forEach(conn=>{
        if(conn.open){ try{ conn.send(payload); }catch(err){ console.warn('send state failed', err); } }
      });
    }

    function syncState(){ if(isHostMode) broadcastState(); }

    function sendToPlayer(id, data){
      const conn = playerConnections.get(id);
      if(conn && conn.open){ try{ conn.send(data); }catch(err){ console.warn('send message failed', err); } }
    }

    // v10ï¼šåœ¨ v9ï¼ˆç„¡å…¬æ¯ï¼‹æŠ½å¡ä¸å†è·³äººï¼‰çš„åŸºç¤ä¸Šï¼ŒåŠ å…¥ã€ŒéŠæˆ²å¡æ± ã€ä¸¦æ”¾å¤§ç¿»å¡å­—é«”
    const DEFAULT = { tiles:[
      { t:'START', type: 'start', desc: 'å› æ­¤åœ°ä¸å‡†åœç•™ï¼Œè«‹å–å®Œå ´ä¸Šçš„å…¬æ¯' },
      { t:'ç¨è‡ªå–é…’', type: 'normal', desc: 'è‡ªè±ªåœ°å– 1 æ¯' },
      { t:'æ©Ÿæœƒ', type: 'chance', desc: 'é›»è…¦éš¨æ©ŸæŠ½ä¸€å¼µæ©Ÿæœƒç‰Œ' },
      { t:'æ•¦è¦ªç¦é„°', type: 'normal', desc: 'å’Œå·¦å³å…©ä½ç©å®¶çŒœæ‹³ï¼Œæœ€è¼¸çš„å– 1 æ¯' },
      { t:'éŠæˆ²æ™‚é–“',type:'game',desc:'æŠ½ 1 å¼µã€ŒéŠæˆ²å¡ã€ä¾†ç©æœ¬å›åˆå°éŠæˆ²'},
      { t:'å‘½é‹', type: 'destiny', desc: 'é›»è…¦éš¨æ©ŸæŠ½ä¸€å¼µå‘½é‹ç‰Œ'},
      { t:'å°å§å€’é…’', type: 'shot', desc: 'åŠ å…¥ä»»æ„ 1 é …é…’æˆ–é£²æ–™æ–¼å…¬æ¯ä¸­' },
      { t:'å¾®é†ºå°æ†©',type:'beer', desc:'åœç•™åœ¨æ­¤æ ¼é–“å¯ä»¥ç²å¾—ä¸Šå»æ‰€çš„æ©Ÿæœƒ'},
      { t:'æ±ºé¬¥',type:'normal',desc:'æ‰¾ 1 ä½å†¤å®¶å‚µä¸»çŒœæ‹³ï¼Œè¼¸çš„å– 1 æ¯'},
      { t:'å‘½é‹',type:'destiny', desc: 'é›»è…¦éš¨æ©ŸæŠ½ä¸€å¼µå‘½é‹ç‰Œ'},
      { t:'å°å§å€’é…’', type: 'shot', desc: 'åŠ å…¥ä»»æ„ 1 é …é…’æˆ–é£²æ–™æ–¼å…¬æ¯ä¸­' },
      { t:'æ©Ÿæœƒ',type:'chance', desc: 'é›»è…¦éš¨æ©ŸæŠ½ä¸€å¼µæ©Ÿæœƒç‰Œ'},
      { t:'éŠæˆ²æ™‚é–“',type:'game',desc:'æŠ½ 1 å¼µã€ŒéŠæˆ²å¡ã€ä¾†ç©æœ¬å›åˆå°éŠæˆ²'},
      { t:'æ•¦è¦ªç¦é„°', type: 'normal', desc: 'å’Œå·¦å³å…©ä½ç©å®¶çŒœæ‹³ï¼Œæœ€è¼¸çš„å– 1 æ¯' },
      { t:'SHOTå…¬æ¯',type:'danger',desc:'ä¹¾æ‰å…¬æ¯'},
      { t:'éŠæˆ²æ™‚é–“',type:'game',desc:'æŠ½ 1 å¼µã€ŒéŠæˆ²å¡ã€ä¾†ç©æœ¬å›åˆå°éŠæˆ²'}, 
      { t:'å‘½é‹',type:'destiny', desc: 'é›»è…¦éš¨æ©ŸæŠ½ä¸€å¼µå‘½é‹ç‰Œ'},
      { t:'æ±ºé¬¥',type:'normal',desc:'æ‰¾ 1 ä½å†¤å®¶å‚µä¸»çŒœæ‹³ï¼Œè¼¸çš„å– 1 æ¯'},
      { t:'æŒ‡å®šå–é…’',type:'normal',desc:'æŒ‡å®š 1 äººå– 2 æ¯'},
      { t:'æ©Ÿæœƒ',type:'chance', desc: 'é›»è…¦éš¨æ©ŸæŠ½ä¸€å¼µæ©Ÿæœƒç‰Œ'},
      { t:'å°å§å€’é…’', type: 'shot', desc: 'åŠ å…¥ä»»æ„ 1 é …é…’æˆ–é£²æ–™æ–¼å…¬æ¯ä¸­' },
      { t:'å¾®é†ºå°æ†©',type:'beer',desc:'åœç•™åœ¨æ­¤æ ¼é–“å¯ä»¥ç²å¾—ä¸Šå»æ‰€çš„æ©Ÿæœƒ'},
      { t:'å‘½é‹',type:'destiny', desc: 'é›»è…¦éš¨æ©ŸæŠ½ä¸€å¼µå‘½é‹ç‰Œ'},
      { t:'æ©Ÿæœƒ',type:'chance', desc: 'é›»è…¦éš¨æ©ŸæŠ½ä¸€å¼µæ©Ÿæœƒç‰Œ'},
      { t:'éŠæˆ²æ™‚é–“',type:'game',desc:'æŠ½ 1 å¼µã€ŒéŠæˆ²å¡ã€ä¾†ç©æœ¬å›åˆå°éŠæˆ²'},
      { t:'SHOTå…¬æ¯',type:'danger',desc:'ä¹¾æ‰å…¬æ¯'},
      { t:'åˆ¶è£',type:'normal',desc:'é™¤äº†è‡ªå·±ä»¥å¤–ï¼Œå ´ä¸Šçš„æ¯ 1 ä½ç©å®¶éƒ½è¦å– 1 æ¯'},
      { t:'å°å§å€’é…’', type: 'shot', desc: 'åŠ å…¥ä»»æ„ 1 é …é…’æˆ–é£²æ–™æ–¼å…¬æ¯ä¸­'}
    ], chance:[
      {text:'å¤§å®¶ä¹¾æ¯ï¼Œæ‰€æœ‰ç©å®¶ä¸€èµ·å– 1 æ¯',code:''},
      {text:'æŒ‡å®š 2 ä½ç©å®¶å„å– 1 æ¯',code:''},
      {text:'æ­å–œç²å¾—ä¸Šå»æ‰€çš„æ©Ÿæœƒï¼ˆåªæœ‰ç•¶å‰å›åˆå¯ä»¥ä½¿ç”¨ï¼‰',code:''},
      {text:'å¾ç¾åœ¨é–‹å§‹ï¼Œä½ åªèƒ½ä½¿ç”¨ã€Œè‡ºèªã€é€²è¡Œæºé€šï¼Œç›´åˆ°ä½ å†æ¬¡ç¶“éã€ŒSTARTã€ã€‚è‹¥èªªå‡ºéå°èªä»¥å¤–çš„èªè¨€å‰‡è™•ç½°å– 1 æ¯é…’ï¼Œèªª 1 æ¬¡å– 1 æ¯ï¼Œä¾æ­¤è¨ˆç®—',code:''},
      {text:'å¾ç¾åœ¨é–‹å§‹ï¼Œä½ åªèƒ½ä½¿ç”¨ã€Œè‹±æ–‡ã€é€²è¡Œæºé€šï¼Œç›´åˆ°ä½ å†æ¬¡ç¶“éã€ŒSTARTã€ã€‚è‹¥èªªå‡ºéå°èªä»¥å¤–çš„èªè¨€å‰‡è™•ç½°å– 1 æ¯é…’ï¼Œèªª 1 æ¬¡å– 1 æ¯ï¼Œä¾æ­¤è¨ˆç®—',code:''},
      {text:'æŠ½ç‰Œï¼šæ’²å…‹ç‰ŒæŠ½åˆ°å¹¾å°±å–å¹¾æ¯ï¼ˆè¥¿è£ç‰Œç‚º Passï¼‰',code:''},
      {text:'é€²å…¥æˆ’é…’å‹’æˆ’æ‰€ï¼Œæš«åœä¸€å›åˆ',code:'player.skip=true'},
      {text:'é™ªé…’å°å§ï¼šç•¶å ´ä¸Šä»» 1 ç©å®¶å–é…’ï¼Œä½ ä¹Ÿå¿…é ˆé™ªè©²ç©å®¶ä¸€èµ·å–ï¼Œç›´åˆ°ä½ å†æ¬¡ç¶“éã€ŒSTARTã€ã€‚ï¼ˆè‹¥æœ‰ç©å®¶å–åˆ°å…¬æ¯å‰‡å¯ä»¥ä¸å¿…é™ªå–ï¼‰',code:''},
      {text:'å°å§å€’é…’ï¼šåŠ å…¥ä»»æ„ 1 é …é…’æˆ–é£²æ–™æ–¼å…¬æ¯ä¸­',code:''},
      {text:'æˆ‘æ˜¯å¤§æ…ˆå–„å®¶ï¼šè«‹å–æ‰ç•¶å‰çš„å…¬æ¯ï¼Œå¤§å®¶æœƒæ„Ÿè¬ä½ !!',code:''}
    ], destiny:[
      {text:'å›åˆ° START ä¸¦å–æ‰å…¬æ¯',code:'player.pos=0; player.sips+=1; refreshPawn()'},
      {text:'é€²å…¥æˆ’é…’å‹’æˆ’æ‰€ï¼Œæš«åœä¸€å›åˆ',code:'player.skip=true'},
      {text:'éª°å­å†æ“²ä¸€æ¬¡',code:'extraRoll()'},
      {text:'æ­å–œç²å¾—ä¸Šå»æ‰€çš„æ©Ÿæœƒï¼ˆåªæœ‰ç•¶å‰å›åˆå¯ä»¥ä½¿ç”¨ï¼‰',code:''},
      {text:'å¾ç¾åœ¨é–‹å§‹ç¦æ­¢èªªå‡ºã€Œæˆ‘ã€é€™å€‹å­—ï¼Œç›´åˆ°ä½ å†æ¬¡ç¶“éã€ŒSTARTã€ã€‚è‹¥èªªå‡ºè©²å­—è™•ç½°å– 1 æ¯é…’ï¼Œèªª 1 æ¬¡å– 1 æ¯ï¼Œä¾æ­¤è¨ˆç®—',code:''},
      {text:'å¾ç¾åœ¨é–‹å§‹ç¦æ­¢èªªå‡ºã€Œä½ ã€é€™å€‹å­—ï¼Œç›´åˆ°ä½ å†æ¬¡ç¶“éã€ŒSTARTã€ã€‚è‹¥èªªå‡ºè©²å­—è™•ç½°å– 1 æ¯é…’ï¼Œèªª 1 æ¬¡å– 1 æ¯ï¼Œä¾æ­¤è¨ˆç®—',code:''},
      {text:'å¾ç¾åœ¨é–‹å§‹ç¦æ­¢èªªå‡ºã€Œä»–ã€é€™å€‹å­—ï¼Œç›´åˆ°ä½ å†æ¬¡ç¶“éã€ŒSTARTã€ã€‚è‹¥èªªå‡ºè©²å­—è™•ç½°å– 1 æ¯é…’ï¼Œèªª 1 æ¬¡å– 1 æ¯ï¼Œä¾æ­¤è¨ˆç®—',code:''},
      {text:'åœ¨å ´æ‰€æœ‰ç”·ç”Ÿå–ä¸€æ¯',code:''},
      {text:'åœ¨å ´æ‰€æœ‰å¥³ç”Ÿå–ä¸€æ¯',code:''},
      {text:'å°å§å€’é…’ï¼šåŠ å…¥ä»»æ„ 1 é …é…’æˆ–é£²æ–™æ–¼å…¬æ¯ä¸­',code:''}
    ], game:[
      {text:'çœŸå¿ƒè©±å¤§å†’éšª',code:''},
      {text:'ç«¹ç­ç«¹ç­è¹¦è¹¦å‡º',code:''},
      {text:'skr éŠæˆ²',code:''},
      {text:'æ’²å…‹ç‰Œæ•¸å­—æ¯”å¤§å°ï¼šç”±ä½ å…ˆå–Šå‡ºè¦æ¯”å¤§é‚„æ˜¯æ¯”å°ä¹‹å¾Œï¼Œæ‰€æœ‰äººæŠ½ä¸€å¼µæ’²å…‹ç‰Œï¼›è‹¥èŠå®¶å–Šæ¯”å°ï¼Œå‰‡æŠ½å‡ºæœ€å¤§å¼µç‰Œçš„ç©å®¶å– 1 æ¯',code:''},
      {text:'3*3 å°„é¾é–€ï¼šå°‡ 9 å¼µæ’²å…‹ç‰Œæ”¾ç½®æ–¼æ¡Œä¸Šï¼Œç”±ä½ é–‹å§‹å°æ¡Œä¸Š 9 å †ä¸­ä»»ä¸€å †å–Šå‡ºä¸‹ä¸€å¼µç¿»é–‹çš„ç‰Œæ¯”ç‰Œå †çš„ç‰Œé¢å¤§æˆ–å°ã€‚è‹¥å–Šå‡ºèˆ‡ç‰Œé¢æ•¸å­—å¤§å°ä¸ç¬¦è€…ï¼Œæœ‰å¹¾å¼µå°±å–ç‰Œæ•¸ä¸€åŠçš„æ¯æ•¸ï¼Œæ’æŸ±å‰‡å–ç‰Œæ•¸çš„æ¯æ•¸',code:''},
      {text:'èª°æ˜¯è‡¥åº•',code:''},
      {text:'æµ·å¸¶æ‹³ / ä½›ç¥–æ‹³ / çƒé¾œçƒé¾œç¿¹ å‰‡ä¸€',code:''},
      {text:'5 10 15 20',code:''},
      {text:'èœåœ’æœåœ’å‹•ç‰©åœ’ï¼ˆå¯è‡ªè¡Œæƒ³ä¸»é¡Œï¼‰',code:''},
      {text:'æˆ‘å¾ä¾†æ²’æœ‰ï¼šèˆ‡èŠå®¶ä¹˜æ•¸äº‹å¯¦ç›¸åçš„ç©å®¶å– 1 æ¯',code:''},
      {text:'å–Šåˆ° 3 å°±æ‹æ‰‹',code:''},
      {text:'é›»æ¢¯ä¸Šä¸‹æ¨“',code:''},
      {text:'çµ‚æ¥µå¯†ç¢¼ï¼šç”±ä½ è¨­å®š 0 ~ 100 ä»»ä¸€æ•¸å­—ï¼Œæ¯ä½ç©å®¶ä¾åºçŒœä¸€æ•¸å­—ã€‚è‹¥ç„¡çŒœä¸­å‰‡æœƒé™ç¸®ç¯„åœå¾Œå†ç”±ä¸‹ä¸€ç©å®¶æŒçºŒçŒœï¼Œæœ€çµ‚çŒœä¸­æ•¸å­—è€…å‰‡å– 1 æ¯',code:''}
    ]};

    const COLORS=['#4fd1c5','#60a5fa','#a78bfa','#f472b6','#fb7185','#f59e0b','#34d399','#f87171','#22c55e','#93c5fd','#e879f9','#38bdf8'];
    const state={ players:[], turn:0, chance:[], destiny:[], game:[], moving:false, extra:false, anim:false, waitingEnd:false };
    let cfg=JSON.parse(JSON.stringify(DEFAULT));

    const N=8, board=$('#board'); const tileEls=[];
    const isPerimeter=(r,c)=> r===0||c===0||r===N-1||c===N-1;

    function buildBoard(){
      board.innerHTML=''; tileEls.length=0;
      const pad = {t:'ç©ºåœ°',type:'normal',desc:''};
      const ring = cfg.tiles.slice(0,28); while(ring.length<28) ring.push({...pad});
      for(let r=0;r<N;r++){
        for(let c=0;c<N;c++){
          if(isPerimeter(r,c)){
            let i; if(r===0){ i=c } else if(c===N-1){ i=(N-1)+r } else if(r===N-1){ i=(N-1)+(N-1)+(N-1 - c) } else { i=(N-1)*3 + (N-1 - r) }
            const t = ring[i];
            const e = el('div',`tile ${t.type||'normal'}`);
            e.style.gridRow=r+1; e.style.gridColumn=c+1; e.innerHTML=`<div class="tag">${i}</div><div><b>${t.t}</b></div>`; e.title=t.desc||t.t; board.appendChild(e); tileEls[i]=e;
          } else {
            const g = el('div','ghost'); g.style.gridRow=r+1; g.style.gridColumn=c+1; board.appendChild(g);
          }
        }
      }
      placePawns();
    }

    function indexToGrid(i){ if(i<N) return {r:0,c:i}; if(i<N+(N-1)) return {r:i-(N-1),c:N-1}; if(i<N+(N-1)+(N-1)) return {r:N-1,c:(N-1)-(i-(N+(N-1)))}; return {r:(N-1)-(i-(N+(N-1)+(N-1))),c:0}; }

    function addPlayer(name, options={}){
      name = (name||'').toString().trim();
      if(!name) return null;
      if(state.players.length>=20){ if(!options.silent) alert('æœ€å¤š 20 ä½ç©å®¶'); return null; }
      const color=(options.color)||COLORS[state.players.length%COLORS.length];
      const player={id:safeRandomId(),name,color,pos:0,sips:0,totalSips:0,skip:false,buff:0,pawn:null,avatar:options.avatar||null,remote:!!options.remote,connectionId:options.connectionId||null};
      state.players.push(player);
      renderPlayers();
      placePawns();
      log(`åŠ å…¥ç©å®¶ï¼š${name}`);
      if(state.players.length===1) refreshTurnInfo();
      updateControls();
      updateRemoteStatus();
      syncState();
      return player;
    }
    function removePlayer(id){
      const i=state.players.findIndex(p=>p.id===id);
      if(i>=0){
        const [p]=state.players.splice(i,1);
        if(p.remote){
          const conn=playerConnections.get(p.id);
          if(conn){
            try{ conn.send({type:'removed'}); }catch(err){ console.warn(err); }
            conn.playerId=null;
          }
          playerConnections.delete(p.id);
        }
        if(controlState.tile && controlState.tile.controllerId===p.id){ controlState.tile.controllerId=null; }
        if(controlState.card && controlState.card.controllerId===p.id){ controlState.card.controllerId=null; }
        if(state.players.length===0){ state.turn=0; }
        else if(state.turn>=state.players.length){ state.turn=state.turn%state.players.length; }
        log(`ç§»é™¤ç©å®¶ï¼š${p.name}`);
        renderPlayers();
        placePawns();
        refreshTurnInfo();
        updateControls();
        updateRemoteStatus();
        syncState();
      }
    }
    function renderPlayers(){
      const list=$('#playerList');
      if(!list) return;
      list.innerHTML='';
      state.players.forEach((p,idx)=>{
        const row=el('div',`card ${idx===state.turn?'active':''}`);
        const head=el('div','row player-head');
        if(p.avatar){
          const img=el('img','player-avatar');
          img.src=p.avatar;
          img.alt=p.name;
          head.appendChild(img);
        } else {
          const dot=el('div','player-dot');
          dot.style.background=p.color;
          head.appendChild(dot);
        }
        head.appendChild(el('div','',`<b>${p.name}</b>`));
        if(p.remote){ head.appendChild(el('span','remote-tag','æ‰‹æ©Ÿé€£ç·š')); }
        const metaInfo=[`ä½ç½® ${p.pos}`,`ç¸½ ${p.totalSips} å£`];
        if(p.skip) metaInfo.push('ä¸‹å›åˆè·³é');
        const meta=el('div','',`<div style="font-size:12px;color:var(--muted)">${metaInfo.join(' Â· ')}</div>`);
        const m=el('div','meter');
        const bar=el('span');
        bar.style.width=Math.min(100,(p.sips*10))+'%';
        m.appendChild(bar);
        const rm=el('button','btn','ç§»é™¤');
        rm.onclick=()=>removePlayer(p.id);
        row.appendChild(head);
        row.appendChild(meta);
        row.appendChild(m);
        row.appendChild(rm);
        list.appendChild(row);
      });
    }

    function placePawns(){
      document.querySelectorAll('.pawn').forEach(n=>n.remove());
      state.players.forEach(p=>{
        const tile=tileEls[p.pos];
        if(!tile) return;
        const rect=tile.getBoundingClientRect(), boardRect=board.getBoundingClientRect();
        const x=rect.left-boardRect.left+rect.width/2, y=rect.top-boardRect.top+rect.height/2;
        const pawnEl=el('div','pawn');
        pawnEl.style.borderColor=p.color;
        if(p.avatar){
          pawnEl.classList.add('has-avatar');
          const img=el('img');
          img.src=p.avatar;
          img.alt=p.name;
          pawnEl.appendChild(img);
        } else {
          pawnEl.style.background=p.color;
        }
        pawnEl.style.transform=`translate(${x}px, ${y}px)`;
        board.appendChild(pawnEl);
        p.pawn=pawnEl;
      });
    }
    window.addEventListener('resize', placePawns);

    function refreshTurnInfo(){ if(state.players.length===0){ $('#turnName').textContent='â€”'; $('#turnPos').textContent='0'; return;} const p=state.players[state.turn%state.players.length]; $('#turnName').textContent=p.name; $('#turnPos').textContent=p.pos; $('#guardHint').textContent = state.waitingEnd ? 'è«‹å…ˆã€ŒçµæŸå›åˆã€å†ç”±ä¸‹ä¸€ä½æ“²éª°ã€‚' : ''; renderPlayers(); }

    function nextTurn(){
      if(state.players.length===0) return;
      const p=state.players[state.turn];
      const delta=Math.max(0,p.sips+p.buff);
      if(delta>0) log(`${p.name} å–æ‰ ${delta} å£ã€‚`);
      p.totalSips+=Math.max(0,delta);
      p.sips=0; p.buff=0;
      state.turn=(state.turn+1)%state.players.length;
      const n=state.players[state.turn];
      if(n&&n.skip){
        log(`${n.name} è·³éæœ¬å›åˆã€‚`);
        n.skip=false;
        state.turn=(state.turn+1)%state.players.length;
      }
      state.extra=false;
      state.waitingEnd=false;
      refreshTurnInfo();
      updateControls();
      syncState();
    }

    const H=[];
    function pushSnapshot(){ const snap={ turn: state.turn, waitingEnd: state.waitingEnd, chance: JSON.parse(JSON.stringify(state.chance)), destiny: JSON.parse(JSON.stringify(state.destiny)), game: JSON.parse(JSON.stringify(state.game)), players: state.players.map(p=>({name:p.name,color:p.color,pos:p.pos,sips:p.sips,totalSips:p.totalSips,skip:p.skip,buff:p.buff})) }; H.push(snap); updateControls(); }
    function undo(){ if(!H.length) return; const s=H.pop(); state.turn=s.turn; state.waitingEnd=s.waitingEnd; state.chance=s.chance; state.destiny=s.destiny; state.game=s.game; state.players.forEach((p,i)=>{ const d=s.players[i]; if(!d) return; p.pos=d.pos; p.sips=d.sips; p.totalSips=d.totalSips; p.skip=d.skip; p.buff=d.buff; }); placePawns(); renderPlayers(); refreshTurnInfo(); updateControls(); log('å·²å›å¾©åˆ°ä¸Šä¸€æ­¥'); }

    // æ“²éª°æµç¨‹ï¼ˆä¿ç•™ v9 çš„ä¿®æ­£ï¼šç­‰å¡ç‰Œé—œé–‰å¾Œæ‰é€²å…¥æ›äººï¼‰
    function roll(opts={}){
      const fromRemote=opts.fromRemote;
      const playerId=opts.playerId;
      if(state.players.length===0){ if(!fromRemote) alert('è«‹å…ˆåŠ å…¥ç©å®¶'); else if(playerId) sendToPlayer(playerId,{type:'info',message:'ç›®å‰æ²’æœ‰ç©å®¶'}); return false; }
      if(state.anim||state.moving) return false;
      if(state.waitingEnd){
        if(fromRemote&&playerId) sendToPlayer(playerId,{type:'info',message:'è«‹å…ˆçµæŸå›åˆ'});
        else alert('è«‹å…ˆæŒ‰ã€ŒçµæŸå›åˆã€ï¼Œå†ç”±ä¸‹ä¸€ä½æ“²éª°ã€‚');
        return false;
      }
      const current=state.players[state.turn];
      if(fromRemote && current && current.id!==playerId){ sendToPlayer(playerId,{type:'info',message:'å°šæœªè¼ªåˆ°ä½ '}); return false; }
      pushSnapshot();
      const p=current; let t=0; state.anim=true; $('#dice').classList.add('spin');
      const iv=setInterval(()=>{
        $('#dice').textContent=(Math.floor(Math.random()*6)+1);
        if(++t>10){
          clearInterval(iv);
          const d=Math.floor(Math.random()*6)+1;
          $('#dice').textContent=d; $('#dice').classList.remove('spin'); state.anim=false;
          log(`${p.name} æ“²å‡º ${d}`);
          movePawn(p,d)
            .then(()=> resolveTile(p))
            .then(()=>{
              if(state.extra){
                state.extra=false;
                setTimeout(()=>{ log('é¡å¤–æ“²éª°ï¼'); roll(); },300);
              } else {
                if($('#autoNext').checked){ nextTurn(); }
                else { state.waitingEnd = true; refreshTurnInfo(); updateControls(); }
              }
              syncState();
            });
        }
      },70);
      return true;
    }

    function movePawn(player,steps){
      return new Promise(res=>{
        if(state.moving) return res();
        state.moving=true;
        const total=Math.abs(steps); let moved=0; const dir=steps>=0?1:-1;
        const timer=setInterval(()=>{
          player.pos=(player.pos+dir+(4*(N-1)))%(4*(N-1));
          updatePawnPosition(player);
          moved++;
          if(moved>=total){ clearInterval(timer); state.moving=false; syncState(); res(); }
        },220);
      });
    }
    function updatePawnPosition(p){ const tile=tileEls[p.pos]; if(!tile) return; const rect=tile.getBoundingClientRect(), boardRect=board.getBoundingClientRect(); const x=rect.left-boardRect.left+rect.width/2, y=rect.top-boardRect.top+rect.height/2; p.pawn.style.transform=`translate(${x}px, ${y}px)`; refreshTurnInfo(); }

    // åœæ ¼ â†’ ç¿»å¡é¡¯ç¤º â†’ åŸ·è¡Œæ•ˆæœ
    function resolveTile(p){
      return new Promise(resolve=>{
        const t=getRing28()[p.pos%28];
        const after=()=>{
          switch(t.type){
            case 'start': p.sips+=1; log(`${p.name} åœåœ¨ STARTï¼Œ+1 æ¯`); break;
            case 'beer': p.sips+=1; log(`${p.name} è§¸ç™¼ã€Œ${t.t}ã€ï¼Œ+1 æ¯ã€‚`); break;
            case 'danger': p.sips+=2; log(`${p.name} è§¸ç™¼å±éšªæ ¼ã€Œ${t.t}ã€ï¼Œ+2 æ¯ã€‚`); break;
            case 'chance': openCard('chance', resolve); return;
            case 'destiny': openCard('destiny', resolve); return;
            case 'game': openCard('game', resolve); return;
            default: if(t.desc) log(`${p.name}ï¼š${t.desc}`);
          }
          renderPlayers();
          syncState();
          resolve();
        };
        showTileModal(t, after);
      });
    }

    function showTileModal(t, onOk){
      const active=state.players[state.turn]||null;
      controlState.tile={
        title:t.t,
        type:t.type,
        desc:t.desc||'æ²’æœ‰é¡å¤–è¦å‰‡',
        flipped:false,
        controllerId:active?active.id:null
      };
      pendingTileOnOk=onOk||null;
      $('#tileTitle').textContent=t.t;
      $('#tileType').textContent=t.type;
      $('#tileDesc').textContent=controlState.tile.desc;
      $('#flip').classList.remove('flipped');
      $('#modalTile').style.display='flex';
      const flipBtn=$('#btnFlip');
      const okBtn=$('#btnTileOk');
      if(flipBtn){
        flipBtn.onclick=handleHostTileFlip;
        flipBtn.disabled=false;
        flipBtn.textContent='ç¿»é–‹å…§å®¹';
        if(active&&active.remote){
          flipBtn.disabled=true;
          flipBtn.textContent='ç­‰å¾…ç©å®¶ç¿»é–‹';
        }
      }
      if(okBtn){
        okBtn.onclick=handleHostTileOk;
        okBtn.disabled=true;
        okBtn.textContent=active&&active.remote?'ç­‰å¾…ç©å®¶ç¿»é–‹':'è«‹å…ˆç¿»é–‹';
      }
      syncState();
    }

    function handleHostTileFlip(){
      const active=state.players[state.turn]||null;
      if(active&&active.remote) return;
      applyTileFlip();
    }

    function handleHostTileOk(){
      if(controlState.tile && !controlState.tile.flipped){
        const active=state.players[state.turn]||null;
        if(active&&active.remote){
          alert('è«‹ç­‰å¾…è©²ç©å®¶ç¿»é–‹å…§å®¹');
          return;
        }
        applyTileFlip();
        return;
      }
      completeTileModal();
    }

    function applyTileFlip(){
      if(!controlState.tile || controlState.tile.flipped) return;
      $('#flip').classList.add('flipped');
      controlState.tile.flipped=true;
      const flipBtn=$('#btnFlip');
      const okBtn=$('#btnTileOk');
      if(flipBtn){
        flipBtn.disabled=true;
        flipBtn.textContent='å…§å®¹å·²ç¿»é–‹';
      }
      if(okBtn){
        okBtn.disabled=false;
        okBtn.textContent='äº†è§£ï¼ŒåŸ·è¡Œ';
      }
      syncState();
    }

    function completeTileModal(){
      if(!controlState.tile) return;
      $('#modalTile').style.display='none';
      const cb=pendingTileOnOk;
      pendingTileOnOk=null;
      controlState.tile=null;
      syncState();
      cb&&cb();
    }

    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr }
    function refill(type){ if(type==='chance') state.chance=shuffle([...cfg.chance]); else if(type==='destiny') state.destiny=shuffle([...cfg.destiny]); else if(type==='game') state.game=shuffle([...cfg.game]); }
    function extraRoll(){ state.extra=true }
    function refreshPawn(){ placePawns(); refreshTurnInfo(); }
    function getRing28(){ const pad = {t:'ç©ºåœ°',type:'normal',desc:''}; const ring = cfg.tiles.slice(0,28); while(ring.length<28) ring.push({...pad}); return ring }

    function openCard(type, onDone){
      const label = type==='chance' ? 'æ©Ÿæœƒå¡' : (type==='destiny' ? 'å‘½é‹å¡' : 'éŠæˆ²å¡');
      const active=state.players[state.turn]||null;
      controlState.card={ deck:type,label,flipped:false,controllerId:active?active.id:null,text:null };
      pendingCardOnDone=onDone||null;
      $('#cardDeckTitle').textContent=label;
      $('#cardText').textContent='';
      $('#flipCard').classList.remove('flipped');
      $('#modalCard').style.display='flex';
      $('#btnFlipCard').onclick=handleHostCardFlip;
      $('#btnCardOk').onclick=handleHostCardOk;
      syncState();
    }

    function handleHostCardFlip(){ revealCurrentCard(); }

    function handleHostCardOk(){
      if(controlState.card && !controlState.card.flipped) revealCurrentCard();
      closeCardModal();
    }

    function revealCurrentCard(){
      if(!controlState.card || controlState.card.flipped) return;
      const type=controlState.card.deck;
      if(!type) return;
      if(state[type].length===0) refill(type);
      const card=state[type].pop();
      controlState.card.flipped=true;
      controlState.card.text=card.text;
      $('#flipCard').classList.add('flipped');
      $('#cardText').textContent=card.text;
      try{
        const player=state.players[state.turn];
        const players=state.players;
        const move=n=>movePawn(player,n);
        const fn=new Function('player','players','move','extraRoll','refreshPawn', card.code||'');
        fn(player,players,move,extraRoll,refreshPawn);
      }catch(e){
        log(`å¡ç‰ŒåŸ·è¡ŒéŒ¯èª¤ï¼š${e.message}`);
      }
      renderPlayers();
      log(`[${controlState.card.label}] ${card.text}`);
      syncState();
    }

    function closeCardModal(){
      if(!controlState.card) return;
      $('#modalCard').style.display='none';
      const done=pendingCardOnDone;
      pendingCardOnDone=null;
      controlState.card=null;
      syncState();
      done&&done();
    }

    function setupHostNetworking(){
      remoteStatusEl=$('#remoteStatus');
      joinUrlEl=$('#joinUrl');
      roomCodeEl=$('#roomCode');
      joinQrCanvas=$('#joinQR');
      copyJoinBtn=$('#copyJoinLink');
      remoteJoinCardEl=$('#remoteJoinCard');
      remoteJoinToggleBtn=$('#remoteJoinToggle');
      remoteJoinContentEl=$('#remoteJoinContent');
      remoteCollapsedHintEl=$('#remoteCollapsedHint');
      setRemoteJoinCollapsed(false);
      if(remoteJoinToggleBtn){
        remoteJoinToggleBtn.onclick=()=>setRemoteJoinCollapsed(!remoteJoinCollapsed);
      }
      if(remoteCollapsedHintEl){
        remoteCollapsedHintEl.onclick=()=>setRemoteJoinCollapsed(false);
      }
      if(!remoteStatusEl) return;
      if(!window.Peer){
        remoteStatusEl.textContent='è¡Œå‹•åŠ å…¥åŠŸèƒ½ç„¡æ³•å•Ÿç”¨ï¼ˆPeerJS æœªè¼‰å…¥ï¼‰';
        if(copyJoinBtn) copyJoinBtn.disabled=true;
        return;
      }
      roomId = generateRoomId();
      if(roomCodeEl) roomCodeEl.textContent=roomId;
      const joinUrl=new URL(location.href);
      joinUrl.search=`?join=${roomId}`;
      joinUrl.hash='';
      const joinUrlText=joinUrl.toString();
      if(joinUrlEl){ joinUrlEl.textContent=joinUrlText; joinUrlEl.href=joinUrlText; }
      if(copyJoinBtn){
        copyJoinBtn.disabled=false;
        copyJoinBtn.onclick=async()=>{
          try{
            await navigator.clipboard.writeText(joinUrlText);
            copyJoinBtn.textContent='å·²è¤‡è£½';
            setTimeout(()=>copyJoinBtn.textContent='è¤‡è£½é€£çµ',1600);
          }catch(err){
            alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç¶²å€');
          }
        };
      }
      if(joinQrCanvas && window.QRCode && QRCode.toCanvas){
        QRCode.toCanvas(joinQrCanvas, joinUrlText,{width:200,margin:1},err=>{ if(err) console.warn(err); });
      }
      remoteStatusEl.textContent='æ­£åœ¨å»ºç«‹æˆ¿é–“â€¦';
      peerInstance = new Peer(`alco-${normalizeRoomId(roomId)}`,buildPeerOptions({debug:2}));
      peerInstance.on('open',()=>{ peerReady=true; remoteStatusEl.textContent='ç­‰å¾…ç©å®¶åŠ å…¥'; updateRemoteStatus(); syncState(); });
      peerInstance.on('connection',conn=>{
        peerConnections.add(conn);
        updateRemoteStatus();
        const sendState=()=>{ if(conn.open){ try{ conn.send({type:'state',payload:getPublicState()}); }catch(err){ console.warn(err); } } };
        if(conn.open) sendState(); else conn.on('open',()=>{ updateRemoteStatus(); sendState(); });
        conn.on('data',data=>handleClientMessage(conn,data));
        const cleanup=()=>handleClientDisconnect(conn);
        conn.on('close',cleanup);
        conn.on('error',cleanup);
      });
      peerInstance.on('disconnected',()=>{
        peerReady=false;
        if(remoteStatusEl) remoteStatusEl.textContent='ä¸»æ©Ÿé€£ç·šä¸­æ–·ï¼Œé‡æ–°é€£ç·šä¸­â€¦';
        try{ peerInstance.reconnect(); }catch(reconnectErr){ console.warn('host reconnect failed',reconnectErr); }
      });
      peerInstance.on('close',()=>{
        peerReady=false;
        if(remoteStatusEl) remoteStatusEl.textContent='ä¸»æ©Ÿé€£ç·šå·²é—œé–‰ï¼Œè«‹é‡æ–°æ•´ç†é é¢ä»¥é‡å»ºæˆ¿é–“ã€‚';
      });
      peerInstance.on('error',err=>{
        console.error(err);
        remoteStatusEl.textContent='é€£ç·šéŒ¯èª¤ï¼š'+(err&&err.message?err.message:err);
      });
    }

    function handleClientMessage(conn,data){
      if(!data||typeof data!=='object') return;
      switch(data.type){
        case 'join':{
          const name=(data.name||'').toString().trim();
          if(!name){ conn.send({type:'error',message:'è«‹è¼¸å…¥æš±ç¨±'}); return; }
          if(conn.playerId){
            const player=state.players.find(p=>p.id===conn.playerId);
            if(player){
              player.avatar=data.avatar||player.avatar;
              player.name=name;
              renderPlayers();
              placePawns();
              refreshTurnInfo();
              updateControls();
              syncState();
            }
            return;
          }
          if(state.players.length>=20){ conn.send({type:'error',message:'ç©å®¶å·²é”ä¸Šé™'}); return; }
          const player=addPlayer(name,{avatar:data.avatar||null,remote:true,connectionId:conn.peer,silent:true});
          if(!player){ conn.send({type:'error',message:'ç„¡æ³•åŠ å…¥éŠæˆ²'}); return; }
          playerConnections.set(player.id,conn);
          conn.playerId=player.id;
          conn.send({type:'joined',playerId:player.id});
          updateRemoteStatus();
          syncState();
          break;
        }
        case 'roll':
          if(conn.playerId) roll({fromRemote:true,playerId:conn.playerId});
          break;
        case 'endTurn':
          if(conn.playerId){
            const active=state.players[state.turn];
            if(!active||active.id!==conn.playerId){ sendToPlayer(conn.playerId,{type:'info',message:'å°šæœªè¼ªåˆ°ä½ '}); }
            else if(!state.waitingEnd){ sendToPlayer(conn.playerId,{type:'info',message:'è«‹å…ˆå®Œæˆæ“²éª°'}); }
            else { nextTurn(); }
          }
          break;
        case 'tileFlip':
          if(conn.playerId && controlState.tile && controlState.tile.controllerId===conn.playerId){
            applyTileFlip();
          }
          break;
        case 'tileDone':
          if(conn.playerId){
            if(!controlState.tile || controlState.tile.controllerId!==conn.playerId){
              sendToPlayer(conn.playerId,{type:'info',message:'ç­‰å¾…ä¸»æŒäººé€²è¡Œä¸‹ä¸€æ­¥'});
            }else if(!controlState.tile.flipped){
              sendToPlayer(conn.playerId,{type:'info',message:'è«‹å…ˆç¿»é–‹å…§å®¹'});
            }else{
              completeTileModal();
            }
          }
          break;
        case 'cardFlip':
          if(conn.playerId && controlState.card && controlState.card.controllerId===conn.playerId){
            revealCurrentCard();
          }
          break;
        case 'cardDone':
          if(conn.playerId){
            if(!controlState.card || controlState.card.controllerId!==conn.playerId){
              sendToPlayer(conn.playerId,{type:'info',message:'ç­‰å¾…ä¸»æŒäººé€²è¡Œä¸‹ä¸€æ­¥'});
            }else if(!controlState.card.flipped){
              sendToPlayer(conn.playerId,{type:'info',message:'è«‹å…ˆç¿»é–‹å¡ç‰Œ'});
            }else{
              closeCardModal();
            }
          }
          break;
        case 'adminLogin':{
          const password=(data.password||'').toString();
          if(password===ADMIN_PASSWORD){
            conn.isAdmin=true;
            adminConnections.add(conn);
            conn.send({type:'admin',status:'granted'});
            try{ conn.send({type:'state',payload:getPublicState()}); }catch(err){ console.warn(err); }
          } else {
            conn.isAdmin=false;
            adminConnections.delete(conn);
            conn.send({type:'admin',status:'denied',message:'å¯†ç¢¼éŒ¯èª¤'});
          }
          updateRemoteStatus();
          break;
        }
        case 'adminAction':{
          if(!conn.isAdmin){
            conn.send({type:'admin',status:'denied',message:'å°šæœªé€šéç®¡ç†å“¡é©—è­‰'});
            break;
          }
          const action=data.action;
          let success=false;
          let handled=true;
          let infoMessage='';
          switch(action){
            case 'roll':
              success=!!roll({fromRemote:true});
              if(!success) infoMessage='ç›®å‰ç„¡æ³•æ“²éª°ï¼Œè«‹ç¢ºèªæ˜¯å¦å°šæœ‰äº‹ä»¶é€²è¡Œä¸­ã€‚';
              break;
            case 'endTurn':
              if(state.waitingEnd){
                nextTurn();
                success=true;
              } else {
                infoMessage='å°šæœªé€²å…¥çµæŸå›åˆéšæ®µã€‚';
                log('ç®¡ç†å“¡è«‹æ±‚çµæŸå›åˆï¼Œä½†ç›®å‰å°šæœªé€²å…¥çµæŸéšæ®µã€‚');
              }
              break;
            case 'undo':
              if(H.length>0){
                undo();
                success=true;
              } else {
                infoMessage='ç›®å‰æ²’æœ‰å¯å›å¾©çš„æ­¥é©Ÿã€‚';
              }
              break;
            case 'setAutoNext':
              if($('#autoNext')) $('#autoNext').checked=!!data.value;
              updateControls();
              syncState();
              success=true;
              break;
            case 'reset':
              log('ç®¡ç†å“¡é ç«¯é‡è¨­éŠæˆ²ã€‚');
              if(conn.open){ conn.send({type:'admin',status:'ok',action:'reset'}); }
              location.reload();
              return;
            default:
              handled=false;
              break;
          }
          if(conn.open && handled){
            if(success){
              conn.send({type:'admin',status:'ok',action, value:data.value});
            } else {
              conn.send({type:'admin',status:'info',action,message:infoMessage||'ç„¡æ³•åŸ·è¡ŒæŒ‡ä»¤'});
            }
          }
          break;
        }
        default:
          break;
      }
    }

    function handleClientDisconnect(conn){
      peerConnections.delete(conn);
      if(conn.isAdmin){
        adminConnections.delete(conn);
        conn.isAdmin=false;
      }
      if(conn.playerId){
        const idx=state.players.findIndex(p=>p.id===conn.playerId);
        if(idx>=0){
          const player=state.players[idx];
          if(player.remote){
            state.players.splice(idx,1);
            playerConnections.delete(player.id);
            if(state.players.length===0) state.turn=0; else if(state.turn>=state.players.length) state.turn=state.turn%state.players.length;
            log(`${player.name} å·²é›¢ç·šä¸¦é›¢é–‹éŠæˆ²`);
            renderPlayers();
            placePawns();
            refreshTurnInfo();
            updateControls();
            syncState();
          }
        }
        conn.playerId=null;
      }
      updateRemoteStatus();
    }

    function setupClientNetworking(code){
      clientStatusEl=$('#clientStatusText');
      clientMessageEl=$('#clientMessage');
      clientJoinCardEl=$('#clientJoinCard');
      clientControlsEl=$('#clientControls');
      clientPlayersEl=$('#clientPlayers');
      clientLogEl=$('#clientLog');
      clientRollBtn=$('#clientRollBtn');
      clientEndBtn=$('#clientEndBtn');
      clientTurnNameEl=$('#clientTurnName');
      clientPosEl=$('#clientPos');
      clientDiceInfoEl=$('#clientDiceInfo');
      clientPlayersCardEl=$('#clientPlayersCard');
      clientLogCardEl=$('#clientLogCard');
      clientJoinBtnEl=$('#clientJoinBtn');
      clientNameInputEl=$('#clientName');
      clientAvatarInputEl=$('#clientAvatar');
      clientTileModalEl=$('#clientTileModal');
      clientTileFlipWrapEl=$('#clientTileFlip');
      clientTileFlipBtnEl=$('#clientTileFlipBtn');
      clientTileOkBtnEl=$('#clientTileOkBtn');
      clientTileTitleEl=$('#clientTileTitle');
      clientTileTypeEl=$('#clientTileType');
      clientTileDescEl=$('#clientTileDesc');
      clientTileHintEl=$('#clientTileHint');
      clientTileControllerHintEl=$('#clientTileControllerHint');
      clientCardModalEl=$('#clientCardModal');
      clientCardFlipWrapEl=$('#clientCardFlip');
      clientCardFlipBtnEl=$('#clientCardFlipBtn');
      clientCardOkBtnEl=$('#clientCardOkBtn');
      clientCardDeckEl=$('#clientCardDeck');
      clientCardTextEl=$('#clientCardText');
      clientCardHintEl=$('#clientCardHint');
      clientCardControllerHintEl=$('#clientCardControllerHint');
      clientAdminCardEl=$('#clientAdminCard');
      clientAdminPasswordInputEl=$('#clientAdminPassword');
      clientAdminLoginBtnEl=$('#clientAdminLoginBtn');
      clientAdminStatusEl=$('#clientAdminStatus');
      clientAdminControlsEl=$('#clientAdminControls');
      clientAdminAutoNextEl=$('#clientAdminAutoNext');
      clientAdminActionBtns=Array.from(document.querySelectorAll('[data-admin-action]'));
      if(clientReconnectTimer){ clearTimeout(clientReconnectTimer); clientReconnectTimer=null; }
      clientContext.allowReconnect=true;
      if(clientContext.peer){
        try{ clientContext.peer.destroy(); }catch(err){ console.warn('peer cleanup failed',err); }
      }
      clientContext.peer=null;
      clientContext.conn=null;
      if(clientControlsEl) clientControlsEl.style.display='none';
      if(clientRollBtn) clientRollBtn.disabled=true;
      if(clientEndBtn) clientEndBtn.disabled=true;
      if(clientTileModalEl) clientTileModalEl.style.display='none';
      if(clientCardModalEl) clientCardModalEl.style.display='none';
      resetClientAdmin();
      const roomLabel=$('#clientRoomCode');
      roomId=(code||'').toString().toUpperCase();
      if(roomLabel) roomLabel.textContent=roomId||'â€”';
      if(!roomId){ if(clientStatusEl) clientStatusEl.textContent='ç¼ºå°‘æˆ¿é–“ä»£ç¢¼ï¼Œè«‹é‡æ–°æƒæ QR Codeã€‚'; return; }
      if(!window.Peer){ if(clientStatusEl) clientStatusEl.textContent='è¡Œå‹•æ§åˆ¶æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'; if(clientJoinCardEl) clientJoinCardEl.style.display='none'; return; }
      if(clientJoinBtnEl) clientJoinBtnEl.disabled=true;
      showClientMessage('');
      const peer=new Peer(undefined,buildPeerOptions({debug:2}));
      clientContext.peer=peer;
      if(clientStatusEl) clientStatusEl.textContent='æ­£åœ¨å˜—è©¦é€£ç·šâ€¦';
      peer.on('open',()=>{
        if(clientStatusEl) clientStatusEl.textContent='å·²é€£ç·šï¼Œç­‰å¾…ä¸»æ©Ÿå›æ‡‰â€¦';
        const conn=peer.connect(`alco-${normalizeRoomId(roomId)}`,{reliable:true});
        clientContext.conn=conn;
        conn.on('open',()=>{
          const canAutoRejoin = !!(clientContext.lastProfile && clientContext.allowReconnect);
          if(canAutoRejoin){
            if(clientStatusEl) clientStatusEl.textContent='é€£ç·šæˆåŠŸï¼Œæ­£åœ¨é‡æ–°åŠ å…¥â€¦';
            if(clientJoinBtnEl) clientJoinBtnEl.disabled=true;
            try{
              conn.send({type:'join',name:clientContext.lastProfile.name,avatar:clientContext.lastProfile.avatar});
            }catch(err){
              console.warn('auto rejoin failed',err);
              if(clientStatusEl) clientStatusEl.textContent='é€£ç·šæˆåŠŸï¼Œä½†è‡ªå‹•é‡æ–°åŠ å…¥å¤±æ•—ï¼Œè«‹æ‰‹å‹•å†è©¦ä¸€æ¬¡ã€‚';
              if(clientJoinBtnEl) clientJoinBtnEl.disabled=false;
            }
          }else{
            if(clientStatusEl) clientStatusEl.textContent='é€£ç·šæˆåŠŸï¼Œè«‹è¼¸å…¥æš±ç¨±åŠ å…¥ã€‚';
            if(clientJoinBtnEl) clientJoinBtnEl.disabled=false;
          }
        });
        conn.on('data',handleHostMessage);
        conn.on('close',()=>{
          const shouldRetry=clientContext.allowReconnect;
          clientContext.conn=null;
          clientContext.joined=false;
          clientContext.playerId=null;
          if(clientControlsEl) clientControlsEl.style.display='none';
          if(clientTileModalEl) clientTileModalEl.style.display='none';
          if(clientCardModalEl) clientCardModalEl.style.display='none';
          resetClientAdmin();
          if(shouldRetry){
            if(clientStatusEl) clientStatusEl.textContent='èˆ‡ä¸»æ©Ÿé€£ç·šä¸­æ–·ï¼Œæ­£åœ¨é‡æ–°é€£ç·šâ€¦';
            scheduleClientReconnect('èˆ‡ä¸»æ©Ÿé€£ç·šä¸­æ–·ï¼Œæ­£åœ¨é‡æ–°é€£ç·šâ€¦');
          }else{
            if(clientJoinCardEl) clientJoinCardEl.style.display='block';
            if(clientJoinBtnEl) clientJoinBtnEl.disabled=false;
            if(clientStatusEl) clientStatusEl.textContent='èˆ‡ä¸»æ©Ÿé€£ç·šä¸­æ–·ã€‚';
            showClientMessage('');
          }
        });
        conn.on('error',err=>{
          if(clientStatusEl) clientStatusEl.textContent='é€£ç·šéŒ¯èª¤ï¼š'+(err&&err.message?err.message:err);
          scheduleClientReconnect('åµæ¸¬åˆ°é€£ç·šéŒ¯èª¤ï¼Œæ­£åœ¨å˜—è©¦é‡æ–°é€£ç·šâ€¦');
        });
      });
      peer.on('error',err=>{
        if(clientStatusEl) clientStatusEl.textContent='å»ºç«‹é€£ç·šå¤±æ•—ï¼š'+(err&&err.message?err.message:err);
        scheduleClientReconnect('èˆ‡ä¼ºæœå™¨é€šè¨Šå¤±æ•—ï¼Œæ­£åœ¨é‡æ–°å˜—è©¦â€¦');
      });
      peer.on('disconnected',()=>{
        scheduleClientReconnect('åµæ¸¬åˆ°èˆ‡ä¼ºæœå™¨ä¸­æ–·ï¼Œæ­£åœ¨é‡æ–°é€£ç·šâ€¦');
      });
      setupClientControls();
    }

    function showClientMessage(text,type='info'){
      if(!clientMessageEl) return;
      clientMessageEl.textContent=text||'';
      clientMessageEl.style.color=type==='error'?'#ff9b9b':'var(--muted)';
    }

    function showAdminStatus(text,type='info'){
      if(!clientAdminStatusEl) return;
      clientAdminStatusEl.textContent=text||'';
      clientAdminStatusEl.style.color=type==='error'?'#ff9b9b':'var(--muted)';
    }

    function resetClientAdmin(){
      clientAdminState.granted=false;
      if(clientAdminControlsEl) clientAdminControlsEl.style.display='none';
      if(clientAdminLoginBtnEl) clientAdminLoginBtnEl.disabled=false;
      if(clientAdminPasswordInputEl) clientAdminPasswordInputEl.value='';
      showAdminStatus('åƒ…ä¾›é–‹ç™¼è€…ç¶­è­·ä½¿ç”¨ã€‚','info');
    }

    function scheduleClientReconnect(reason){
      if(!clientContext.allowReconnect) return;
      if(clientReconnectTimer) return;
      if(clientStatusEl) clientStatusEl.textContent=reason||'é€£ç·šç•°å¸¸ï¼Œæ­£åœ¨é‡æ–°é€£ç·šâ€¦';
      if(clientJoinBtnEl) clientJoinBtnEl.disabled=true;
      clientReconnectTimer=setTimeout(()=>{
        clientReconnectTimer=null;
        if(clientContext.peer){
          try{ clientContext.peer.destroy(); }catch(err){ console.warn('peer destroy failed',err); }
        }
        clientContext.peer=null;
        clientContext.conn=null;
        clientContext.joined=false;
        clientContext.playerId=null;
        setupClientNetworking(roomId||joinCodeParam||'');
      },1500);
    }

    function updateClientControl(data){
      if(!data) data={};
      const control=data.control||{};
      const players=data.players||[];
      const myId=clientContext.playerId;
      const canSend=clientContext.conn&&clientContext.conn.open;
      const controllerName=playerId=>{
        const found=players.find(p=>p.id===playerId);
        return found?found.name:'';
      };

      const tile=control.tile||null;
      if(clientTileModalEl){
        if(tile){
          clientTileModalEl.style.display='flex';
          if(clientTileTitleEl) clientTileTitleEl.textContent=tile.title||'';
          if(clientTileTypeEl){
            clientTileTypeEl.textContent=tile.type||'';
            clientTileTypeEl.style.display=tile.type?'inline-block':'none';
          }
          if(clientTileDescEl) clientTileDescEl.textContent=tile.flipped?(tile.desc||''): 'ç¿»é–‹å¾Œé¡¯ç¤ºå…§å®¹';
          if(clientTileFlipWrapEl){
            if(tile.flipped) clientTileFlipWrapEl.classList.add('flipped'); else clientTileFlipWrapEl.classList.remove('flipped');
          }
          const ownerName=controllerName(tile.controllerId);
          if(clientTileHintEl){
            if(tile.controllerId && tile.controllerId===myId){
              clientTileHintEl.textContent=tile.flipped?'è«‹ä¾ç…§è¦å‰‡é€²è¡Œã€‚':'è¼ªåˆ°ä½ äº†ï¼Œè«‹ç¿»é–‹å…§å®¹ã€‚';
            }else if(ownerName){
              clientTileHintEl.textContent=tile.flipped?`${ownerName} å·²ç¿»é–‹å…§å®¹ã€‚`:`ç­‰å¾… ${ownerName} ç¿»é–‹å…§å®¹â€¦`;
            }else{
              clientTileHintEl.textContent=tile.flipped?'ä¸»æŒäººå·²ç¿»é–‹å…§å®¹ã€‚':'ç­‰å¾…ä¸»æŒäººç¿»é–‹å…§å®¹â€¦';
            }
          }
          if(clientTileControllerHintEl){
            if(tile.controllerId && tile.controllerId===myId){
              clientTileControllerHintEl.textContent='ç¿»é–‹å¾Œè«‹åœ¨ç¾å ´åŸ·è¡Œè¦å‰‡ã€‚';
            }else if(ownerName){
              clientTileControllerHintEl.textContent=tile.flipped?`${ownerName} æ­£åœ¨åŸ·è¡Œè¦å‰‡ã€‚`:`${ownerName} çš„å›åˆã€‚`;
            }else{
              clientTileControllerHintEl.textContent=tile.flipped?'è«‹ä¾ä¸»æŒäººæŒ‡ç¤ºé€²è¡Œã€‚':'';
            }
          }
          if(clientTileFlipBtnEl){
            const canFlip=!!tile.controllerId && tile.controllerId===myId && !tile.flipped && canSend;
            clientTileFlipBtnEl.disabled=!canFlip;
          }
          if(clientTileOkBtnEl){
            const canConfirm=!!tile.controllerId && tile.controllerId===myId && tile.flipped && canSend;
            clientTileOkBtnEl.disabled=!canConfirm;
          }
        } else {
          clientTileModalEl.style.display='none';
        }
      }

      const card=control.card||null;
      if(clientCardModalEl){
        if(card){
          clientCardModalEl.style.display='flex';
          if(clientCardDeckEl) clientCardDeckEl.textContent=card.label||'æŠ½å¡';
          if(clientCardTextEl) clientCardTextEl.textContent=card.flipped?(card.text||''):'';
          if(clientCardFlipWrapEl){
            if(card.flipped) clientCardFlipWrapEl.classList.add('flipped'); else clientCardFlipWrapEl.classList.remove('flipped');
          }
          const ownerName=controllerName(card.controllerId);
          if(clientCardControllerHintEl){
            if(card.controllerId && card.controllerId===myId){
              clientCardControllerHintEl.textContent=card.flipped?'è«‹ç¢ºèªå¡ç‰Œå…§å®¹ä¸¦åŸ·è¡Œæ•ˆæœã€‚':'è¼ªåˆ°ä½ ç¿»é–‹å¡ç‰Œã€‚';
            }else if(ownerName){
              clientCardControllerHintEl.textContent=card.flipped?`${ownerName} æ­£åœ¨æŸ¥çœ‹å¡ç‰Œã€‚`:`ç­‰å¾… ${ownerName} ç¿»é–‹å¡ç‰Œâ€¦`;
            }else{
              clientCardControllerHintEl.textContent=card.flipped?'ä¸»æŒäººå·²ç¿»é–‹å¡ç‰Œå…§å®¹ã€‚':'';
            }
          }
          if(clientCardFlipBtnEl){
            const canFlip=!!card.controllerId && card.controllerId===myId && !card.flipped && canSend;
            clientCardFlipBtnEl.disabled=!canFlip;
          }
          if(clientCardOkBtnEl){
            const canConfirm=!!card.controllerId && card.controllerId===myId && card.flipped && canSend;
            clientCardOkBtnEl.disabled=!canConfirm;
          }
        } else {
          clientCardModalEl.style.display='none';
        }
      }
    }

    function updateClientState(data){
      if(!data) return;
      if(data.roomId && !roomId) roomId=data.roomId;
      if(clientTurnNameEl){
        const active=data.players.find(p=>p.id===data.activePlayerId);
        clientTurnNameEl.textContent=active?active.name:'â€”';
      }
      if(clientDiceInfoEl) clientDiceInfoEl.textContent=`éª°å­ï¼š${data.dice||'â€”'}`;
      if(clientPlayersEl){
        clientPlayersEl.innerHTML='';
        data.players.forEach(p=>{
          const item=el('div','item');
          item.style.border=p.id===data.activePlayerId?'1px solid var(--accent)':'1px solid rgba(255,255,255,.08)';
          item.style.background=p.id===clientContext.playerId?'rgba(138,198,255,.15)':'rgba(26,36,56,.6)';
          if(p.avatar){
            const img=el('img','player-avatar');
            img.src=p.avatar; img.alt=p.name;
            item.appendChild(img);
          } else {
            const dot=el('div','player-dot');
            dot.style.background=p.color;
            item.appendChild(dot);
          }
          const info=el('div','',`<b>${p.name}</b><div style="font-size:12px;color:var(--muted)">ä½ç½® ${p.pos}</div>`);
          item.appendChild(info);
          clientPlayersEl.appendChild(item);
        });
        if(clientPlayersCardEl) clientPlayersCardEl.style.display=data.players.length?'block':'none';
      }
      if(clientLogEl){
        clientLogEl.innerHTML='';
        (data.logs||[]).forEach(msg=>{ const item=el('div','',msg); clientLogEl.appendChild(item); });
        if(clientLogCardEl) clientLogCardEl.style.display=(data.logs&&data.logs.length)?'block':'none';
      }
      if(clientAdminAutoNextEl && data.settings){
        const desired=!!data.settings.autoNext;
        if(clientAdminAutoNextEl.checked!==desired){
          clientAdminAutoNextEl.checked=desired;
        }
      }
      updateClientControl(data);
      const me=data.players.find(p=>p.id===clientContext.playerId);
      if(clientPosEl) clientPosEl.textContent=me?me.pos:'â€”';
      if(clientControlsEl) clientControlsEl.style.display=clientContext.joined?'block':'none';
      if(clientRollBtn) clientRollBtn.disabled = !(me && data.activePlayerId===me.id && !data.waitingEnd);
      if(clientEndBtn) clientEndBtn.disabled = !(me && data.activePlayerId===me.id && data.waitingEnd);
      if(!me && clientContext.joined){
        clientContext.joined=false;
        clientContext.playerId=null;
        if(clientJoinCardEl) clientJoinCardEl.style.display='block';
        if(clientJoinBtnEl) clientJoinBtnEl.disabled=false;
        showClientMessage('ä½ å·²ä¸åœ¨éŠæˆ²ä¸­ï¼Œå¯é‡æ–°åŠ å…¥ã€‚','error');
      }
    }

    async function readAvatarFile(file){
      if(!file) return null;
      if(file.size>5*1024*1024) throw new Error('åœ–ç‰‡éœ€å°æ–¼ 5 MB');
      const dataUrl=await new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=()=>resolve(reader.result);
        reader.onerror=()=>reject(new Error('ç„¡æ³•è®€å–åœ–ç‰‡'));
        reader.readAsDataURL(file);
      });
      return await new Promise((resolve,reject)=>{
        const img=new Image();
        img.onload=()=>{
          const maxSide=256;
          const scale=Math.min(1,maxSide/Math.max(img.width,img.height));
          const canvas=document.createElement('canvas');
          canvas.width=Math.max(1,Math.round(img.width*scale));
          canvas.height=Math.max(1,Math.round(img.height*scale));
          const ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0,canvas.width,canvas.height);
          resolve(canvas.toDataURL('image/jpeg',0.85));
        };
        img.onerror=()=>reject(new Error('ç„¡æ³•è™•ç†åœ–ç‰‡'));
        img.src=dataUrl;
      });
    }

    function setupClientControls(){
      if(clientJoinBtnEl){
        clientJoinBtnEl.onclick=async()=>{
          if(!clientContext.conn||!clientContext.conn.open){ showClientMessage('å°šæœªèˆ‡ä¸»æ©Ÿé€£ç·š','error'); return; }
          const name=clientNameInputEl ? clientNameInputEl.value.trim() : '';
          if(!name){ showClientMessage('è«‹è¼¸å…¥æš±ç¨±','error'); return; }
          clientJoinBtnEl.disabled=true;
          showClientMessage('æ­£åœ¨åŠ å…¥â€¦');
          try{
            const avatarData = clientAvatarInputEl && clientAvatarInputEl.files && clientAvatarInputEl.files[0] ? await readAvatarFile(clientAvatarInputEl.files[0]) : null;
            clientContext.lastProfile={name,avatar:avatarData};
            clientContext.allowReconnect=true;
            clientContext.conn.send({type:'join',name,avatar:avatarData});
          }catch(err){
            showClientMessage(err.message||'åŠ å…¥å¤±æ•—','error');
            clientJoinBtnEl.disabled=false;
          }
        };
      }
      if(clientRollBtn){
        clientRollBtn.onclick=()=>{
          if(clientContext.conn&&clientContext.conn.open&&clientContext.playerId){
            clientContext.conn.send({type:'roll',playerId:clientContext.playerId});
            clientRollBtn.disabled=true;
          }
        };
      }
      if(clientEndBtn){
        clientEndBtn.onclick=()=>{
          if(clientContext.conn&&clientContext.conn.open&&clientContext.playerId){
            clientContext.conn.send({type:'endTurn',playerId:clientContext.playerId});
          }
        };
      }
      if(clientTileFlipBtnEl){
        clientTileFlipBtnEl.onclick=()=>{
          if(clientContext.conn&&clientContext.conn.open&&clientContext.playerId){
            clientContext.conn.send({type:'tileFlip'});
            clientTileFlipBtnEl.disabled=true;
          }
        };
      }
      if(clientTileOkBtnEl){
        clientTileOkBtnEl.onclick=()=>{
          if(clientContext.conn&&clientContext.conn.open&&clientContext.playerId){
            clientContext.conn.send({type:'tileDone'});
          }
        };
      }
      if(clientCardFlipBtnEl){
        clientCardFlipBtnEl.onclick=()=>{
          if(clientContext.conn&&clientContext.conn.open&&clientContext.playerId){
            clientContext.conn.send({type:'cardFlip'});
            clientCardFlipBtnEl.disabled=true;
          }
        };
      }
      if(clientCardOkBtnEl){
        clientCardOkBtnEl.onclick=()=>{
          if(clientContext.conn&&clientContext.conn.open&&clientContext.playerId){
            clientContext.conn.send({type:'cardDone'});
          }
        };
      }
      if(clientAdminLoginBtnEl){
        clientAdminLoginBtnEl.onclick=()=>{
          if(!clientContext.conn||!clientContext.conn.open){ showAdminStatus('å°šæœªèˆ‡ä¸»æ©Ÿé€£ç·š','error'); return; }
          const pwd=clientAdminPasswordInputEl?clientAdminPasswordInputEl.value:'';
          if(!pwd){ showAdminStatus('è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼','error'); return; }
          clientAdminLoginBtnEl.disabled=true;
          showAdminStatus('é©—è­‰ä¸­â€¦');
          clientContext.conn.send({type:'adminLogin',password:pwd});
        };
      }
      if(clientAdminAutoNextEl){
        clientAdminAutoNextEl.onchange=()=>{
          if(!clientAdminState.granted||!clientContext.conn||!clientContext.conn.open){
            clientAdminAutoNextEl.checked=!clientAdminAutoNextEl.checked;
            showAdminStatus('å°šæœªå–å¾—ç®¡ç†å“¡æ¬Šé™','error');
            return;
          }
          clientContext.conn.send({type:'adminAction',action:'setAutoNext',value:clientAdminAutoNextEl.checked});
        };
      }
      if(clientAdminActionBtns.length){
        clientAdminActionBtns.forEach(btn=>{
          btn.onclick=()=>{
            if(!clientAdminState.granted){ showAdminStatus('å°šæœªå–å¾—ç®¡ç†å“¡æ¬Šé™','error'); return; }
            if(!clientContext.conn||!clientContext.conn.open){ showAdminStatus('å°šæœªèˆ‡ä¸»æ©Ÿé€£ç·š','error'); return; }
            const action=btn.getAttribute('data-admin-action');
            if(action==='reset'){
              showAdminStatus('å·²é€å‡ºé‡æ–°é–‹å±€æŒ‡ä»¤ï¼Œä¸»æ©Ÿå°‡é‡æ–°æ•´ç†ã€‚','info');
            }
            clientContext.conn.send({type:'adminAction',action});
          };
        });
      }
    }

    function handleHostMessage(msg){
      if(!msg||typeof msg!=='object') return;
      switch(msg.type){
        case 'state':
          updateClientState(msg.payload);
          break;
        case 'joined':
          clientContext.joined=true;
          clientContext.playerId=msg.playerId;
          clientContext.allowReconnect=true;
          if(clientStatusEl) clientStatusEl.textContent='åŠ å…¥æˆåŠŸï¼Œè«‹ç­‰å¾…è¼ªåˆ°ä½ ã€‚';
          if(clientJoinCardEl) clientJoinCardEl.style.display='none';
          if(clientJoinBtnEl) clientJoinBtnEl.disabled=false;
          showClientMessage('åŠ å…¥æˆåŠŸï¼');
          break;
        case 'error':
          showClientMessage(msg.message||'åŠ å…¥å¤±æ•—','error');
          if(clientJoinBtnEl) clientJoinBtnEl.disabled=false;
          break;
        case 'info':
          showClientMessage(msg.message||'');
          break;
        case 'removed':
          clientContext.joined=false;
          clientContext.playerId=null;
          clientContext.allowReconnect=false;
          clientContext.lastProfile=null;
          if(clientStatusEl) clientStatusEl.textContent='ä½ å·²è¢«ç§»å‡ºéŠæˆ²ï¼Œå¯é‡æ–°åŠ å…¥ã€‚';
          if(clientJoinCardEl) clientJoinCardEl.style.display='block';
          if(clientJoinBtnEl) clientJoinBtnEl.disabled=false;
          if(clientControlsEl) clientControlsEl.style.display='none';
          if(clientTileModalEl) clientTileModalEl.style.display='none';
          if(clientCardModalEl) clientCardModalEl.style.display='none';
          showClientMessage('ä½ å·²è¢«ç§»å‡ºéŠæˆ²ï¼Œå¯é‡æ–°åŠ å…¥ã€‚','error');
          break;
        case 'admin':
          if(msg.status==='granted'){
            clientAdminState.granted=true;
            if(clientAdminControlsEl) clientAdminControlsEl.style.display='block';
            if(clientAdminLoginBtnEl) clientAdminLoginBtnEl.disabled=true;
            if(clientAdminPasswordInputEl) clientAdminPasswordInputEl.value='';
            showAdminStatus('å·²å–å¾—ç®¡ç†å“¡æ¬Šé™ã€‚','info');
          }else if(msg.status==='denied'){
            clientAdminState.granted=false;
            if(clientAdminLoginBtnEl) clientAdminLoginBtnEl.disabled=false;
            if(clientAdminControlsEl) clientAdminControlsEl.style.display='none';
            showAdminStatus(msg.message||'é©—è­‰å¤±æ•—','error');
          }else if(msg.status==='ok'){
            if(msg.action==='setAutoNext' && typeof msg.value==='boolean' && clientAdminAutoNextEl){
              clientAdminAutoNextEl.checked=msg.value;
            }
            if(msg.action!=='setAutoNext'){
              showAdminStatus('æŒ‡ä»¤å·²é€é”ä¸»æ©Ÿã€‚','info');
            }
          }else if(msg.status==='info'){
            if(msg.action==='setAutoNext' && typeof msg.value==='boolean' && clientAdminAutoNextEl){
              clientAdminAutoNextEl.checked=msg.value;
            }
            showAdminStatus(msg.message||'ç›®å‰ç„¡æ³•åŸ·è¡ŒæŒ‡ä»¤','error');
          }
          break;
        default:
          break;
      }
    }

    function setupNetworking(){
      if(isHostMode) setupHostNetworking();
      else setupClientNetworking(joinCodeParam||'');
    }

    // ç·¨è¼¯å™¨
    function openEditor(){ renderTileTable(); renderCardList('#chanceList',cfg.chance); renderCardList('#destinyList',cfg.destiny); renderCardList('#gameList',cfg.game); $('#modalEditor').style.display='flex' }
    function closeEditor(){ $('#modalEditor').style.display='none'; buildBoard(); $('#chancePeek').textContent=`${cfg.chance.length} å¼µï¼ˆæ´—ç‰Œå¾ŒæŠ½å–ï¼‰`; $('#destinyPeek').textContent=`${cfg.destiny.length} å¼µï¼ˆæ´—ç‰Œå¾ŒæŠ½å–ï¼‰`; $('#gamePeek').textContent=`${cfg.game.length} å¼µï¼ˆæ´—ç‰Œå¾ŒæŠ½å–ï¼‰`; log('è¨­å®šå·²å„²å­˜ã€‚'); }

    function updateTileCount(){ const n = cfg.tiles.length; $('#tileCount').textContent = `ï¼ˆç›®å‰ ${n}ï¼Œå¤–åœˆä½¿ç”¨å‰ 28 æ ¼ï¼‰`; }

    function renderTileTable(){ const tb=$('#tblTiles tbody'); tb.innerHTML=''; cfg.tiles.forEach((t,i)=>{ const tr=el('tr'); tr.appendChild(el('td','',i)); const tdT=el('td'); const inT=el('input'); inT.value=t.t; inT.oninput=()=>{t.t=inT.value}; tdT.appendChild(inT); tr.appendChild(tdT); const tdTy=el('td'); const sel=el('select'); ['start','chance','destiny','shot','beer','danger','game','normal'].forEach(k=>{ const o=el('option','',k); o.value=k; if(k===t.type) o.selected=true; sel.appendChild(o)}); sel.onchange=()=>t.type=sel.value; tdTy.appendChild(sel); tr.appendChild(tdTy); const tdD=el('td'); const ta=el('textarea'); ta.value=t.desc||''; ta.oninput=()=>t.desc=ta.value; tdD.appendChild(ta); tr.appendChild(tdD); const tdA=el('td'); const rm=el('button','btn','åˆªé™¤'); rm.onclick=()=>{ cfg.tiles.splice(i,1); renderTileTable(); updateTileCount(); buildBoard(); }; tdA.appendChild(rm); tr.appendChild(tdA); tb.appendChild(tr); }); updateTileCount(); }

    function renderCardList(sel,arr){ const box=$(sel); box.innerHTML=''; arr.forEach((c,i)=>{ const card=el('div','card'); const title=el('input'); title.value=c.text; title.style.width='100%'; title.oninput=()=>c.text=title.value; const code=el('textarea'); code.placeholder='effect ç¨‹å¼ç¢¼ï¼Œå¯ç”¨ï¼šplayer, players, move(n), extraRoll(), refreshPawn()'; code.value=c.code||''; code.oninput=()=>c.code=code.value; const rm=el('button','btn','åˆªé™¤'); rm.onclick=()=>{arr.splice(i,1); renderCardList(sel,arr)}; card.appendChild(title); card.appendChild(code); card.appendChild(rm); box.appendChild(card); }); }

    $('#btnEditor').onclick=openEditor; $('#btnClose').onclick=closeEditor; $('#btnDefault').onclick=()=>{ cfg=JSON.parse(JSON.stringify(DEFAULT)); openEditor(); }
    $('#addTile').onclick=()=>{ cfg.tiles.push({t:'æ–°æ ¼å­',type:'normal',desc:''}); renderTileTable(); updateTileCount(); };
    $('#pad28').onclick=()=>{ while(cfg.tiles.length<28) cfg.tiles.push({t:'ç©ºåœ°',type:'normal',desc:''}); renderTileTable(); updateTileCount(); buildBoard(); };
    $('#addChance').onclick=()=>{ cfg.chance.push({text:'æ–°æ©Ÿæœƒå¡',code:''}); renderCardList('#chanceList',cfg.chance) };
    $('#addDestiny').onclick=()=>{ cfg.destiny.push({text:'æ–°å‘½é‹å¡',code:''}); renderCardList('#destinyList',cfg.destiny) };
    $('#addGame').onclick=()=>{ cfg.game.push({text:'æ–°éŠæˆ²å¡',code:''}); renderCardList('#gameList',cfg.game) };

    // å­˜æª”/è®€æª”ï¼ˆå«éŠæˆ²å¡æ± ï¼‰
    $('#btnExportSave').onclick = e=>{ const save={ players: state.players.map(p=>({name:p.name,color:p.color,pos:p.pos,sips:p.sips,totalSips:p.totalSips,skip:p.skip,buff:p.buff})), turn: state.turn, cfg, chance: state.chance, destiny: state.destiny, game: state.game, waitingEnd: state.waitingEnd }; const blob=new Blob([JSON.stringify(save,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); e.target.href=url; e.target.download='alcohol-monopoly-save.json'; };
    $('#btnImportSave').onclick=()=>$('#importSave').click();
    $('#importSave').onchange = ev=>{ const f=ev.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ const data=JSON.parse(rd.result); cfg=data.cfg||cfg; playerConnections.forEach(conn=>{ try{ conn.send({type:'info',message:'ä¸»æ©Ÿå·²è¼‰å…¥æ–°å­˜æª”ï¼Œè«‹é‡æ–°åŠ å…¥ã€‚'}); }catch(e){} conn.playerId=null; }); playerConnections.clear(); state.players=[]; (data.players||[]).forEach(p=>addPlayer(p.name,{silent:true})); state.players.forEach((p,i)=>{ const d=data.players[i]||{}; p.pos=d.pos||0; p.sips=d.sips||0; p.totalSips=d.totalSips||0; p.skip=d.skip||false; p.buff=d.buff||0; p.avatar=d.avatar||null; p.remote=false; p.connectionId=null; }); state.turn=data.turn||0; state.chance=data.chance||[]; state.destiny=data.destiny||[]; state.game=data.game||[]; state.waitingEnd=!!data.waitingEnd; buildBoard(); placePawns(); renderPlayers(); refreshTurnInfo(); updateControls(); updateRemoteStatus(); log('å·²è¼‰å…¥å­˜æª”'); }catch(err){ alert('è¼‰å…¥å¤±æ•—') } }; rd.readAsText(f) };

    function log(t){
      const message=new Date().toLocaleTimeString()+" Â· "+t;
      const box=$('#log');
      if(box){
        const it=el('div','item',message);
        box.prepend(it);
        while(box.children.length>MAX_LOG_HISTORY) box.removeChild(box.lastChild);
      }
      logHistory.unshift(message);
      if(logHistory.length>MAX_LOG_HISTORY) logHistory.splice(MAX_LOG_HISTORY);
      syncState();
    }
    function updateControls(){ $('#roll').disabled = state.waitingEnd || state.anim || state.moving || state.players.length===0; $('#endTurn').disabled = !state.waitingEnd || state.players.length===0; $('#undoBtn').disabled = H.length===0; }

    $('#addPlayer').onclick=()=>{ addPlayer($('#playerName').value.trim()); $('#playerName').value=''; };
    $('#quick2').onclick=()=>{ ['ç©å®¶1','ç©å®¶2'].forEach(addPlayer) };
    $('#quick4').onclick=()=>{ ['ç©å®¶1','ç©å®¶2','ç©å®¶3','ç©å®¶4'].forEach(addPlayer) };
    $('#roll').onclick=roll; $('#endTurn').onclick=nextTurn; $('#undoBtn').onclick=undo;
    $('#btnReset').onclick=()=>{ if(confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿ')) location.reload(); };
    $('#btnHow').onclick=()=>{ alert('ç©æ³•é€Ÿè¦½\n\n1) æ–°å¢ 2~20 ä½ç©å®¶\n2) å¯ç”¨ã€Œæª¢è¦–/ç·¨è¼¯ã€èª¿æ•´æ‰€æœ‰æ ¼å­èˆ‡å¡ç‰Œï¼ˆå«ã€ŒéŠæˆ²å¡ã€ï¼‰\n3) æ“²éª°åœ¨å³ä¸‹è§’æµ®å‹•å€ï¼›åœæ ¼æœƒå½ˆå‡ºç¿»å¡é¡¯ç¤ºè¦å‰‡\n4) å‹¾é¸ã€Œè‡ªå‹•æ›äººã€å¯è‡ªå‹•è¼ªåˆ°ä¸‹ä¸€ä½ï¼›æœªå‹¾é¸æ™‚éœ€æŒ‰ã€ŒçµæŸå›åˆã€ï¼Œç³»çµ±æœƒé–ä½æ“²éª°é¿å…é€£çºŒèµ°å…©è¼ª\n5) å¯ç”¨ã€Œå°å‡º/è¼‰å…¥å­˜æª”ã€ä¿å­˜é€²åº¦\n6) å‡ºç™¼å¾Œè‹¥å†æ¬¡èµ°åˆ°ã€ŒSTARTã€ï¼Œéœ€å–å®Œç•¶å‰å…¬æ¯\n7) æœ¬éŠæˆ²é–‹å§‹å¾Œï¼Œä¸è¨±æœ‰ç©å®¶æ“…è‡ªé›¢å¸­å»å»æ‰€ï¼›è‹¥é€¼ä¸å¾—å·²ï¼Œè«‹è‡ªç½° 2 æ¯å¾Œå³å¯ç”³è«‹å»å»æ‰€\n\næç¤ºï¼šåœåˆ°ã€ŒéŠæˆ²æ™‚é–“ã€æ™‚æœƒå¾ã€ŒéŠæˆ²å¡æ± ã€æŠ½ä¸€å¼µå¡ï¼Œæœ¬å›åˆå°±ç©é‚£å€‹éŠæˆ²ï¼'); };

    function init(){ buildBoard(); $('#chancePeek').textContent=`${DEFAULT.chance.length} å¼µï¼ˆæ´—ç‰Œå¾ŒæŠ½å–ï¼‰`; $('#destinyPeek').textContent=`${DEFAULT.destiny.length} å¼µï¼ˆæ´—ç‰Œå¾ŒæŠ½å–ï¼‰`; $('#gamePeek').textContent=`${DEFAULT.game.length} å¼µï¼ˆæ´—ç‰Œå¾ŒæŠ½å–ï¼‰`; refreshTurnInfo(); updateControls(); log('å•Ÿå‹•éŠæˆ²'); }
    init();
    setupNetworking();
  </script>
</body>
</html>
