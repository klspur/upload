<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é…’ç²¾å¤§å¯Œç¿ â€” åˆä½µå–®æª” v4ï¼ˆå›åˆé˜²å‘†ï¼‹è‡ªå‹•æ›äººï¼‹å›ä¸Šä¸€æ­¥ï¼‰</title>
    <style>
        :root {
            --bg: #0f1116;
            --panel: #151a22;
            --tile: #1c2330;
            --text: #e6f0ff;
            --muted: #a9b6cc;
            --chance: #36b6ff;
            --destiny: #ff70c8;
            --accent: #8ac6ff;
            --start: #f6c549;
            --shot: #ff914d;
            --beer: #5ed471;
            --danger: #ff5757
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: #0e1420;
            color: var(--text);
            font-family: ui-sans-serif, system-ui, "Segoe UI", Noto Sans, Arial;
            overflow: hidden
        }

        .app {
            height: 100%;
            display: grid;
            grid-template-rows: 56px 1fr;
            gap: 8px;
            padding: 10px
        }

        .top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--panel);
            border-radius: 12px;
            padding: 0 10px
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800
        }

        .btn {
            background: #203049;
            border: 1px solid #2e4161;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .grid {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            grid-template-rows: 1fr 170px;
            gap: 10px
        }

        .pane {
            background: var(--panel);
            border-radius: 12px;
            padding: 10px;
            overflow: auto
        }

        .title {
            font-size: 12px;
            color: var(--muted);
            letter-spacing: .5px;
            text-transform: uppercase;
            margin-bottom: 6px
        }

        .card {
            border: 1px solid #324666;
            border-radius: 12px;
            padding: 10px;
            background: #0f1522
        }

        .list {
            display: grid;
            gap: 8px
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center
        }

        input,
        select,
        textarea {
            background: #0f1624;
            border: 1px solid #2c3f60;
            color: var(--text);
            border-radius: 10px;
            padding: 8px
        }

        .meter {
            background: #0b1220;
            border-radius: 8px;
            border: 1px solid #2b3952;
            height: 8px;
            width: 120px;
            position: relative;
            overflow: hidden
        }

        .meter span {
            position: absolute;
            inset: 0;
            width: 0;
            background: linear-gradient(90deg, #77c6ff, #b282ff)
        }

        .board {
            --N: 8;
            width: min(84vh, calc(100% - 24px));
            aspect-ratio: 1/1;
            display: grid;
            grid-template-columns: repeat(var(--N), 1fr);
            grid-template-rows: repeat(var(--N), 1fr);
            gap: 6px;
            background: #0c1220;
            padding: 6px;
            border-radius: 18px;
            border: 1px solid #2b3750;
            box-shadow: inset 0 0 60px rgba(0, 0, 0, .35)
        }

        .tile {
            background: var(--tile);
            border: 1px solid #2b3952;
            border-radius: 12px;
            display: grid;
            place-items: center;
            text-align: center;
            padding: 6px;
            font-size: 12px;
            line-height: 1.15;
            position: relative
        }

        .tile .tag {
            position: absolute;
            top: 6px;
            left: 6px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #0e1522;
            border: 1px solid #263550;
            color: var(--muted)
        }

        .tile.start {
            background: linear-gradient(180deg, #3a2f0a, #2a2209);
            border-color: #6b5411
        }

        .tile.chance {
            background: linear-gradient(180deg, #0b2740, #0b1d30);
            border-color: #205c86
        }

        .tile.destiny {
            background: linear-gradient(180deg, #401433, #2c0f24);
            border-color: #a53b84
        }

        .tile.shot {
            background: linear-gradient(180deg, #3f1504, #2a0e03);
            border-color: #a2431c
        }

        .tile.beer {
            background: linear-gradient(180deg, #123820, #0d2816);
            border-color: #2d8a51
        }

        .tile.danger {
            background: linear-gradient(180deg, #3b0c0c, #2a0808);
            border-color: #a33a3a
        }

        .center {
            display: grid;
            place-items: center;
            overflow: auto
        }

        .table {
            position: absolute;
            inset: 16% 16%;
            border-radius: 18px;
            border: 1px dashed #33425e;
            display: grid;
            place-items: center;
            padding: 10px;
            color: var(--muted)
        }

        .cup {
            display: grid;
            gap: 8px;
            place-items: center;
            padding: 16px 12px;
            background: #0c111a;
            border: 1px solid #2d3a54;
            border-radius: 16px;
            min-width: 160px
        }

        .pawn {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 999px;
            border: 3px solid #fff;
            box-sizing: content-box;
            transform: translate(-50%, -50%);
            transition: transform .3s ease;
            z-index: 10
        }

        .active {
            outline: 2px solid var(--accent);
            box-shadow: 0 0 0 4px rgba(138, 198, 255, .15)
        }

        .footer {
            grid-column: 1/4;
            background: var(--panel);
            border-radius: 12px;
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            align-items: center;
            gap: 10px
        }

        .dice {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: #0f1624;
            border: 1px solid #2b3952;
            display: grid;
            place-items: center;
            font-weight: 800;
            font-size: 22px
        }

        .log {
            height: 100%;
            overflow: auto;
            display: grid;
            gap: 8px
        }

        .log .item {
            font-size: 13px;
            color: #cfe0ff;
            background: #0f1522;
            border: 1px solid #2c3b54;
            padding: 8px 10px;
            border-radius: 10px
        }

        /* æ“²éª°å‹•ç•« */
        .dice.spin {
            animation: spin .7s ease-in-out infinite
        }

        @keyframes spin {
            0% {
                transform: rotate(0)
            }

            50% {
                transform: rotate(15deg)
            }

            100% {
                transform: rotate(-15deg)
            }
        }

        /* Modal é€šç”¨ */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 50
        }

        .box {
            width: min(720px, 96vw);
            max-height: 90vh;
            overflow: auto;
            background: #121a2a;
            border: 1px solid #354765;
            border-radius: 14px;
            padding: 14px
        }

        /* ç·¨è¼¯å™¨è¡¨æ ¼ */
        .tbl {
            width: 100%;
            border-collapse: collapse
        }

        .tbl th,
        .tbl td {
            border: 1px solid #2c3f60;
            padding: 6px 8px;
            font-size: 14px
        }

        .tbl th {
            position: sticky;
            top: 0;
            background: #101827
        }

        /* ç¿»å¡ */
        .flip {
            perspective: 1000px
        }

        .flip-inner {
            position: relative;
            width: 100%;
            min-height: 180px;
            transform-style: preserve-3d;
            transition: transform .5s ease
        }

        .flip.flipped .flip-inner {
            transform: rotateY(180deg)
        }

        .face {
            position: absolute;
            inset: 0;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #2e4161;
            background: #0f1624;
            backface-visibility: hidden
        }

        .back {
            transform: rotateY(180deg)
        }

        .hint {
            font-size: 12px;
            color: var(--muted)
        }

        .toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="top">
            <div class="brand">ğŸ» é…’ç²¾å¤§å¯Œç¿ Â· åˆä½µå–®æª” v4</div>
            <div class="row">
                <button class="btn" id="btnEditor">æª¢è¦– / ç·¨è¼¯ äº‹ä»¶èˆ‡å¡ç‰Œ</button>
                <button class="btn" id="btnSaveCfg">å°å‡ºè¨­å®š</button>
                <input id="cfgFile" type="file" hidden accept="application/json">
                <button class="btn" id="btnLoadCfg">è¼‰å…¥è¨­å®š</button>
                <button class="btn" id="btnReset">é‡é–‹æ–°å±€</button>
                <button class="btn" id="btnHow">å¿«é€Ÿèªªæ˜</button>
            </div>
        </div>

        <div class="grid">
            <div class="pane">
                <div class="title">ç©å®¶</div>
                <div class="card">
                    <div class="row"><input id="playerName" placeholder="ç©å®¶åç¨±ï¼Œä¾‹å¦‚ï¼šå°æ˜"><button class="btn"
                            id="addPlayer">åŠ å…¥</button></div>
                    <div class="row"><button class="btn" id="quick2">å¿«é€Ÿ 2 äºº</button><button class="btn" id="quick4">å¿«é€Ÿ 4
                            äºº</button></div>
                </div>
                <div class="list" id="playerList"></div>
            </div>

            <div class="pane center">
                <div style="position:relative;display:grid;place-items:center">
                    <div class="board" id="board"></div>
                    <div class="table">
                        <div class="cup">
                            <div>å…¬æ¯ç´¯ç©</div>
                            <div class="v" id="cup">0</div>
                            <small>ï¼ˆéƒ¨åˆ†æ•ˆæœæœƒæŠŠé…’é‡ä¸Ÿé€²å…¬æ¯ï¼‰</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pane">
                <div class="title">å¡ç‰Œå€ Cards</div>
                <div class="list">
                    <div class="card">
                        <div class="title">æ©Ÿæœƒ Chance</div>
                        <div id="chancePeek"></div>
                    </div>
                    <div class="card">
                        <div class="title">å‘½é‹ Destiny</div>
                        <div id="destinyPeek"></div>
                    </div>
                    <div class="card">
                        <div class="title">äº‹ä»¶ç´€éŒ„</div>
                        <div class="log" id="log"></div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <div class="row">
                    <div class="dice" id="dice">â€“</div>
                    <button class="btn" id="roll">æ“²éª°</button>
                    <button class="btn" id="endTurn">çµæŸå›åˆ</button>
                    <button class="btn" id="undoBtn">å›ä¸Šä¸€æ­¥</button>
                </div>
                <div style="text-align:center">ç›®å‰ç©å®¶ï¼š<b id="turnName">â€”</b> Â· ä½ç½® <span id="turnPos">0</span>
                    <div class="hint" id="guardHint"></div>
                </div>
                <div class="row" style="justify-content:end;gap:16px">
                    <label class="toggle"><input type="checkbox" id="autoNext"> è‡ªå‹•æ›äºº</label>
                    <a class="btn" id="btnExportSave" href="#">å°å‡ºå­˜æª”</a>
                    <input type="file" id="importSave" hidden accept="application/json">
                    <button class="btn" id="btnImportSave">è¼‰å…¥å­˜æª”</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯å™¨ Modal -->
    <div class="modal" id="modalEditor">
        <div class="box">
            <div class="row" style="justify-content:space-between">
                <div style="font-weight:700">æª¢è¦– / ç·¨è¼¯äº‹ä»¶èˆ‡å¡ç‰Œ</div>
                <div class="row"><button class="btn" id="btnDefault">é‚„åŸé è¨­</button><button class="btn"
                        id="btnClose">å®Œæˆä¸¦é—œé–‰</button></div>
            </div>
            <div class="card">
                <div class="title">æ ¼å­ï¼ˆTilesï¼‰</div>
                <table class="tbl" id="tblTiles">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>æ¨™é¡Œ</th>
                            <th>type</th>
                            <th>æè¿°</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="row" style="margin-top:8px"><button class="btn" id="addTile">æ–°å¢æ ¼å­</button><span
                        class="pill">typeï¼šstart / chance / destiny / shot / beer / danger / normal</span></div>
            </div>
            <div class="row" style="gap:10px">
                <div class="card" style="flex:1">
                    <div class="title">æ©Ÿæœƒï¼ˆChanceï¼‰</div>
                    <div class="list" id="chanceList"></div>
                    <div class="row"><button class="btn" id="addChance">æ–°å¢æ©Ÿæœƒå¡</button></div>
                </div>
                <div class="card" style="flex:1">
                    <div class="title">å‘½é‹ï¼ˆDestinyï¼‰</div>
                    <div class="list" id="destinyList"></div>
                    <div class="row"><button class="btn" id="addDestiny">æ–°å¢å‘½é‹å¡</button></div>
                </div>
            </div>
            <div class="card">
                <div class="title">è¨­å®šåŒ¯å…¥ / åŒ¯å‡º</div>
                <div class="row"><button class="btn" id="btnExportCfg2">å°å‡º JSON</button><input type="file"
                        id="importCfg2" hidden accept="application/json"><button class="btn" id="btnImportCfg2">è¼‰å…¥
                        JSON</button></div>
            </div>
        </div>
    </div>

    <!-- åœæ ¼ç¿»å¡ Modal -->
    <div class="modal" id="modalTile">
        <div class="box">
            <div class="flip" id="flip">
                <div class="flip-inner">
                    <div class="face front">
                        <div class="row" style="justify-content:space-between;align-items:center">
                            <div class="title">ä½ åœåœ¨</div>
                            <button class="btn" id="btnFlip">ç¿»é–‹å…§å®¹</button>
                        </div>
                        <h2 id="tileTitle" style="margin:6px 0 4px"></h2>
                        <div class="pill" id="tileType"></div>
                    </div>
                    <div class="face back">
                        <div class="title">è¦å‰‡å…§å®¹</div>
                        <div id="tileDesc" style="white-space:pre-wrap;line-height:1.5"></div>
                        <div class="row" style="margin-top:12px;justify-content:end"><button class="btn"
                                id="btnTileOk">äº†è§£ï¼ŒåŸ·è¡Œ</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ½å¡ï¼ˆæ©Ÿæœƒ/å‘½é‹ï¼‰Modalï¼šé¡¯ç¤ºå¡é¢èˆ‡æ•ˆæœè¨Šæ¯ -->
    <div class="modal" id="modalCard">
        <div class="box">
            <div class="flip" id="flipCard">
                <div class="flip-inner">
                    <div class="face front">
                        <div class="row" style="justify-content:space-between;align-items:center">
                            <div class="title" id="cardDeckTitle">æŠ½å¡</div><button class="btn"
                                id="btnFlipCard">ç¿»é–‹å¡ç‰Œ</button>
                        </div>
                        <h2 style="margin:6px 0 4px">ï¼Ÿï¼Ÿï¼Ÿ</h2>
                        <div class="pill">é»æ“Šç¿»é–‹ä»¥æŸ¥çœ‹å…§å®¹</div>
                    </div>
                    <div class="face back">
                        <div class="title">å¡ç‰Œå…§å®¹</div>
                        <h3 id="cardText" style="margin:6px 0 8px"></h3>
                        <div id="cardHint" class="hint">å¡ç‰Œæ•ˆæœå°‡ç«‹å³åŸ·è¡Œ</div>
                        <div class="row" style="margin-top:12px;justify-content:end"><button class="btn"
                                id="btnCardOk">å¥½</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const $ = s => document.querySelector(s);
        const el = (t, c, h) => { const e = document.createElement(t); if (c) e.className = c; if (h !== undefined) e.innerHTML = h; return e };
        const sample = arr => arr[Math.floor(Math.random() * arr.length)];

        const DEFAULT = {
            tiles: [
                { t: 'START', type: 'start', desc: 'å‡ºç™¼ï¼æš–èº« +1 å£' },
                { t: 'å‹å–„é„°å±…', type: 'beer', desc: 'è«‹å·¦æ‰‹é‚Šç©å®¶å– 1 å£' },
                { t: 'æ©Ÿæœƒ', type: 'chance' },
                { t: 'æˆ‘æœ€æ£’', type: 'normal', desc: 'è‡ªè±ªåœ°å– 1 å£' },
                { t: 'å‘½é‹', type: 'destiny' },
                { t: 'ä¼åœ°æŒºèº«', type: 'danger', desc: 'åš 5 ä¸‹ï¼Œå¤±æ•—å¤šå– 2 å£' },
                { t: 'SHOT å…¬æ¯', type: 'shot', desc: 'åŠ  2 å£åˆ°å…¬æ¯ï¼›è‹¥å…¬æ¯â‰¥6 å†å–æ‰ 3 å£' },
                { t: 'ä¹¾ä¸€åŠ', type: 'danger', desc: 'å– 3 å£' },
                { t: 'å³è½‰ä¸Šå°', type: 'normal', desc: 'åˆ†äº«å¿ƒæƒ…ï¼Œå– 1 å£' },
                { t: 'å‘½é‹', type: 'destiny' },
                { t: 'æ©Ÿæœƒ', type: 'chance' },
                { t: 'å…¨å ´åˆç…§', type: 'beer', desc: 'æ¯äººå„å– 1 å£' },
                { t: 'é†‰æ‹³è¡¨æ¼”', type: 'danger', desc: 'æŒ‡å®š 1 äººå– 2 å£' },
                { t: 'Happy Hour', type: 'beer', desc: 'è‡ªå·±å°‘å– 1 å£' },
                { t: 'å°·å°¬æ•…äº‹', type: 'normal', desc: 'èªªç³—äº‹ï¼Œå¦å‰‡å– 2 å£' },
                { t: 'SHOT å…¬æ¯', type: 'shot', desc: 'ä¸Ÿ 2 å£é€²å…¬æ¯' },
                { t: 'å‘½é‹', type: 'destiny' },
                { t: 'äº¤æ›åº§ä½', type: 'normal', desc: 'èˆ‡éš¨æ©Ÿç©å®¶äº¤æ›ä½ç½®' },
                { t: 'æ©Ÿæœƒ', type: 'chance' },
                { t: 'æŒ‡å®šå–é…’', type: 'danger', desc: 'æŒ‡å®š 1 äººå– 2 å£' },
                { t: 'è£œæ°´', type: 'beer', desc: 'å–æ°´ 2 å£æŠµ 1 å£é…’' },
                { t: 'å¾®é†ºå°æ†©', type: 'normal', desc: 'å›åˆå¾Œè·³éä¸‹ä¸€å›åˆ' },
                { t: 'å‘½é‹', type: 'destiny' },
                { t: 'æ©Ÿæœƒ', type: 'chance' },
                { t: 'æˆ‘æœ€æ£’', type: 'normal', desc: 'è‡ªè±ªåœ°å– 1 å£' },
                { t: 'SHOT å…¬æ¯', type: 'shot', desc: 'åŠ  3 å£åˆ°å…¬æ¯ï¼Œä¸¦å¾å…¬æ¯å– 1 å£' },
                { t: 'å¹¸é‹ä¹¾æ¯', type: 'beer', desc: 'æŒ‡å®š 1 äººå– 1 å£ï¼Œè‡ªå·±å…å–' },
                { t: 'å›åˆ° START', type: 'normal', desc: 'ç§»å‹•åˆ° START ä¸¦å– 1 å£' }
            ], chance: [
                { text: '+2 å‰é€²', code: 'move(2)' },
                { text: '-2 å¾Œé€€', code: 'move(-2)' },
                { text: 'ä½ å¤ªå¹¸é‹ï¼Œå…å– 1 å£', code: 'player.buff -= 1' },
                { text: 'æŒ‡å®šå…¶ä»–äººå– 2 å£', code: '(p=>{const xs=players.filter(x=>x!==player); if(xs.length){sample(xs).sips+=2}})()' },
                { text: 'å…¬æ¯ +2', code: 'cup.value += 2' }
            ], destiny: [
                { text: 'å›åˆ° START ä¸¦å– 1 å£', code: 'player.pos=0; player.sips+=1; refreshPawn()' },
                { text: 'èˆ‡æœ€é†‰çš„äººäº¤æ›ä½ç½®', code: '(p=>{const ms=[...players].sort((a,b)=>b.totalSips-a.totalSips)[0]; if(ms&&ms!==player){[player.pos,ms.pos]=[ms.pos,player.pos]; refreshPawn()}})()' },
                { text: 'å–æ‰å…¬æ¯ 2 å£ï¼ˆä¸è¶³å‰‡å…¨å–ï¼‰', code: '{const n=Math.min(2,cup.value); cup.value-=n; player.sips+=n}' },
                { text: 'æš«åœä¸€å›åˆ', code: 'player.skip=true' },
                { text: 'éª°å­å†æ“²ä¸€æ¬¡', code: 'extraRoll()' }
            ]
        };

        const COLORS = ['#4fd1c5', '#60a5fa', '#a78bfa', '#f472b6', '#fb7185', '#f59e0b', '#34d399', '#f87171', '#22c55e', '#93c5fd', '#e879f9', '#38bdf8'];
        const state = { players: [], turn: 0, cup: 0, chance: [], destiny: [], moving: false, extra: false, anim: false, waitingEnd: false };
        let cfg = JSON.parse(JSON.stringify(DEFAULT));
        const history = []; // push snapshots for Undo

        const N = 8, board = $('#board'); const tileEls = [];
        function indexToGrid(i) { if (i < N) return { r: 0, c: i }; if (i < N + (N - 1)) return { r: i - (N - 1), c: N - 1 }; if (i < N + (N - 1) + (N - 1)) return { r: N - 1, c: (N - 1) - (i - (N + (N - 1))) }; return { r: (N - 1) - (i - (N + (N - 1) + (N - 1))), c: 0 }; }
        function buildBoard() { board.innerHTML = ''; tileEls.length = 0; for (let i = 0; i < 4 * (N - 1); i++) { const t = cfg.tiles[i % cfg.tiles.length]; const e = el('div', `tile ${t.type || 'normal'}`); const pos = indexToGrid(i); e.style.gridRow = pos.r + 1; e.style.gridColumn = pos.c + 1; e.innerHTML = `<div class="tag">${i}</div><div><b>${t.t}</b></div>`; e.title = t.desc || t.t; board.appendChild(e); tileEls.push(e); } placePawns(); }

        function addPlayer(name) { if (!name) return; if (state.players.length >= 20) return alert('æœ€å¤š 20 ä½ç©å®¶'); const color = COLORS[state.players.length % COLORS.length]; state.players.push({ id: crypto.randomUUID(), name, color, pos: 0, sips: 0, totalSips: 0, skip: false, buff: 0, pawn: null }); renderPlayers(); placePawns(); log(`åŠ å…¥ç©å®¶ï¼š${name}`); if (state.players.length === 1) refreshTurnInfo(); updateControls(); }
        function removePlayer(id) { const i = state.players.findIndex(p => p.id === id); if (i >= 0) { const [p] = state.players.splice(i, 1); log(`ç§»é™¤ç©å®¶ï¼š${p.name}`); renderPlayers(); placePawns(); refreshTurnInfo(); updateControls(); } }
        function renderPlayers() { const list = $('#playerList'); list.innerHTML = ''; state.players.forEach((p, idx) => { const row = el('div', `card ${idx === state.turn ? 'active' : ''}`); const dot = el('div'); dot.style.width = '16px'; dot.style.height = '16px'; dot.style.borderRadius = '999px'; dot.style.border = '2px solid rgba(255,255,255,.7)'; dot.style.background = p.color; const head = el('div', 'row'); head.appendChild(dot); head.appendChild(el('div', '', `<b>${p.name}</b>`)); const meta = el('div', '', `<div style="font-size:12px;color:var(--muted)">ä½ç½® ${p.pos} Â· ç¸½ ${p.totalSips} å£ ${p.skip ? 'Â·ä¸‹å›åˆè·³é' : ''}</div>`); const m = el('div', 'meter'); const bar = el('span'); bar.style.width = Math.min(100, (p.sips * 10)) + '%'; m.appendChild(bar); const rm = el('button', 'btn', 'ç§»é™¤'); rm.onclick = () => removePlayer(p.id); row.appendChild(head); row.appendChild(meta); row.appendChild(m); row.appendChild(rm); list.appendChild(row); }); }

        function placePawns() { document.querySelectorAll('.pawn').forEach(n => n.remove()); state.players.forEach(p => { const pos = indexToGrid(p.pos); const tile = tileEls[p.pos]; if (!tile) return; const rect = tile.getBoundingClientRect(), boardRect = board.getBoundingClientRect(); const x = rect.left - boardRect.left + rect.width / 2, y = rect.top - boardRect.top + rect.height / 2; const pa = el('div', 'pawn'); pa.style.background = p.color; pa.style.transform = `translate(${x}px, ${y}px)`; board.appendChild(pa); p.pawn = pa; }); }
        window.addEventListener('resize', placePawns);

        function refreshTurnInfo() { if (state.players.length === 0) { $('#turnName').textContent = 'â€”'; $('#turnPos').textContent = '0'; return; } const p = state.players[state.turn % state.players.length]; $('#turnName').textContent = p.name; $('#turnPos').textContent = p.pos; $('#guardHint').textContent = state.waitingEnd ? 'è«‹å…ˆã€ŒçµæŸå›åˆã€å†ç”±ä¸‹ä¸€ä½æ“²éª°ï¼Œé¿å…é€£çºŒèµ°å…©è¼ªã€‚' : ''; renderPlayers(); }

        function nextTurn() { if (state.players.length === 0) return; const p = state.players[state.turn]; const delta = Math.max(0, p.sips + p.buff); if (delta > 0) log(`${p.name} å–æ‰ ${delta} å£ã€‚`); p.totalSips += Math.max(0, delta); p.sips = 0; p.buff = 0; state.turn = (state.turn + 1) % state.players.length; const n = state.players[state.turn]; if (n && n.skip) { log(`${n.name} è·³éæœ¬å›åˆã€‚`); n.skip = false; state.turn = (state.turn + 1) % state.players.length; } state.extra = false; state.waitingEnd = false; refreshTurnInfo(); updateControls(); }

        // ===== æ“²éª°ï¼ˆå«å‹•ç•«ï¼‰ï¼‹ é˜²å‘†ï¼šéœ€å…ˆçµæŸå›åˆ
        function roll() {
            if (state.players.length === 0) return alert('è«‹å…ˆåŠ å…¥ç©å®¶'); if (state.anim || state.moving) return; if (state.waitingEnd) { alert('è«‹å…ˆæŒ‰ã€ŒçµæŸå›åˆã€ï¼Œå†ç”±ä¸‹ä¸€ä½æ“²éª°ã€‚'); return; }
            // é€²å…¥è¡Œå‹•å‰ï¼Œè¨˜éŒ„å¿«ç…§ä¾›ã€Œå›ä¸Šä¸€æ­¥ã€
            pushSnapshot();
            const p = state.players[state.turn]; let t = 0; state.anim = true; $('#dice').classList.add('spin'); const iv = setInterval(() => {
                $('#dice').textContent = (Math.floor(Math.random() * 6) + 1); if (++t > 10) {
                    clearInterval(iv); const d = Math.floor(Math.random() * 6) + 1; $('#dice').textContent = d; $('#dice').classList.remove('spin'); state.anim = false; log(`${p.name} æ“²å‡º ${d}`); movePawn(p, d).then(() => {
                        resolveTile(p); if (state.extra) { state.extra = false; setTimeout(() => { log('é¡å¤–æ“²éª°ï¼'); roll(); }, 300); } else {
                            // æœ¬å›åˆè¡Œå‹•å®Œæˆï¼šè‹¥è‡ªå‹•æ›äººï¼Œç›´æ¥ nextTurnï¼›å¦å‰‡é–å®šéœ€æŒ‰çµæŸå›åˆ
                            if ($('#autoNext').checked) { nextTurn(); } else { state.waitingEnd = true; refreshTurnInfo(); updateControls(); }
                        }
                    });
                }
            }, 70);
        }

        function movePawn(player, steps) { return new Promise(res => { if (state.moving) return res(); state.moving = true; const total = Math.abs(steps); let moved = 0; const dir = steps >= 0 ? 1 : -1; const timer = setInterval(() => { player.pos = (player.pos + dir + (4 * (N - 1))) % (4 * (N - 1)); updatePawnPosition(player); moved++; if (moved >= total) { clearInterval(timer); state.moving = false; res(); } }, 220); }); }
        function updatePawnPosition(p) { const tile = tileEls[p.pos]; if (!tile) return; const rect = tile.getBoundingClientRect(), boardRect = board.getBoundingClientRect(); const x = rect.left - boardRect.left + rect.width / 2, y = rect.top - boardRect.top + rect.height / 2; p.pawn.style.transform = `translate(${x}px, ${y}px)`; refreshTurnInfo(); }

        // ===== åœæ ¼ â†’ ç¿»å¡é¡¯ç¤ºï¼Œå†åŸ·è¡Œæ•ˆæœ
        function showTileModal(t, onOk) { $('#tileTitle').textContent = t.t; $('#tileType').textContent = t.type; $('#tileDesc').textContent = (t.desc || 'æ²’æœ‰é¡å¤–è¦å‰‡'); $('#flip').classList.remove('flipped'); $('#modalTile').style.display = 'flex'; $('#btnFlip').onclick = () => $('#flip').classList.add('flipped'); $('#btnTileOk').onclick = () => { $('#modalTile').style.display = 'none'; onOk && onOk(); }; }

        function resolveTile(p) { const t = cfg.tiles[p.pos % cfg.tiles.length]; const after = () => { switch (t.type) { case 'start': p.sips += 1; log(`${p.name} å›åˆ° STARTï¼Œ+1 å£`); break; case 'beer': p.sips += 1; log(`${p.name} è§¸ç™¼ã€Œ${t.t}ã€ï¼Œ+1 å£ã€‚`); break; case 'shot': state.cup += 2; log(`${p.name} è§¸ç™¼ SHOT å…¬æ¯ï¼Œå…¬æ¯ +2ã€‚`); if (state.cup >= 6) { p.sips += 3; state.cup -= 3; log(`å…¬æ¯å·²æ»¿ï¼Œ${p.name} å–æ‰ 3 å£ï¼Œå…¬æ¯ -3`); } break; case 'danger': p.sips += 2; log(`${p.name} è§¸ç™¼å±éšªæ ¼ã€Œ${t.t}ã€ï¼Œ+2 å£ã€‚`); break; case 'chance': openCard('chance'); return; case 'destiny': openCard('destiny'); return; default: if (t.desc) log(`${p.name}ï¼š${t.desc}`); } $('#cup').textContent = state.cup; renderPlayers(); }; showTileModal(t, after); }

        // ===== æŠ½å¡ï¼ˆå«ç¿»å¡é¡¯ç¤ºï¼‰
        function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[arr[i], arr[j]] = [arr[j], arr[i]]; } return arr }
        function refill(type) { state[type] = shuffle(type === 'chance' ? [...cfg.chance] : [...cfg.destiny]); }
        function extraRoll() { state.extra = true }
        function refreshPawn() { placePawns(); refreshTurnInfo(); }

        function openCard(type) {
            $('#cardDeckTitle').textContent = type === 'chance' ? 'æ©Ÿæœƒå¡' : 'å‘½é‹å¡'; $('#flipCard').classList.remove('flipped'); $('#modalCard').style.display = 'flex'; let executed = false; let card; const ensure = () => { if (executed) return; executed = true; if (state[type].length === 0) refill(type); card = state[type].pop(); $('#cardText').textContent = card.text; try { const player = state.players[state.turn], players = state.players; const cup = { get value() { return state.cup }, set value(v) { state.cup = v; $('#cup').textContent = v; } }; const move = (n) => movePawn(player, n); const fn = new Function('player', 'players', 'move', 'cup', 'extraRoll', 'refreshPawn', card.code || ''); fn(player, players, move, cup, extraRoll, refreshPawn); log(`[${type === 'chance' ? 'æ©Ÿæœƒ' : 'å‘½é‹'}] ${card.text}`); renderPlayers(); } catch (e) { log(`å¡ç‰ŒåŸ·è¡ŒéŒ¯èª¤ï¼š${e.message}`); } };
            $('#btnFlipCard').onclick = () => { $('#flipCard').classList.add('flipped'); ensure(); };
            $('#btnCardOk').onclick = () => { $('#modalCard').style.display = 'none'; if (!state.extra) { if ($('#autoNext').checked) { nextTurn(); } else { state.waitingEnd = true; refreshTurnInfo(); updateControls(); } } };
        }

        // ===== ç·¨è¼¯å™¨
        function openEditor() { renderTileTable(); renderCardList('#chanceList', cfg.chance); renderCardList('#destinyList', cfg.destiny); $('#modalEditor').style.display = 'flex' }
        function closeEditor() { $('#modalEditor').style.display = 'none'; buildBoard(); $('#chancePeek').textContent = `${cfg.chance.length} å¼µï¼ˆæ´—ç‰Œå¾ŒæŠ½å–ï¼‰`; $('#destinyPeek').textContent = `${cfg.destiny.length} å¼µï¼ˆæ´—ç‰Œå¾ŒæŠ½å–ï¼‰`; log('è¨­å®šå·²å„²å­˜ã€‚'); }

        function renderTileTable() { const tb = $('#tblTiles tbody'); tb.innerHTML = ''; cfg.tiles.forEach((t, i) => { const tr = el('tr'); tr.appendChild(el('td', '', i)); const tdT = el('td'); const inT = el('input'); inT.value = t.t; inT.oninput = () => t.t = inT.value; tdT.appendChild(inT); tr.appendChild(tdT); const tdTy = el('td'); const sel = el('select');['start', 'chance', 'destiny', 'shot', 'beer', 'danger', 'normal'].forEach(k => { const o = el('option', '', k); o.value = k; if (k === t.type) o.selected = true; sel.appendChild(o) }); sel.onchange = () => t.type = sel.value; tdTy.appendChild(sel); tr.appendChild(tdTy); const tdD = el('td'); const ta = el('textarea'); ta.value = t.desc || ''; ta.oninput = () => t.desc = ta.value; tdD.appendChild(ta); tr.appendChild(tdD); const tdA = el('td'); const rm = el('button', 'btn', 'åˆªé™¤'); rm.onclick = () => { cfg.tiles.splice(i, 1); renderTileTable(); buildBoard(); }; tdA.appendChild(rm); tr.appendChild(tdA); tb.appendChild(tr); }); }
        function renderCardList(sel, arr) { const box = $(sel); box.innerHTML = ''; arr.forEach((c, i) => { const card = el('div', 'card'); const title = el('input'); title.value = c.text; title.style.width = '100%'; title.oninput = () => c.text = title.value; const code = el('textarea'); code.placeholder = 'effect ç¨‹å¼ç¢¼ï¼Œå¯ç”¨ï¼šplayer, players, move(n), cup.value, extraRoll(), refreshPawn()'; code.value = c.code || ''; code.oninput = () => c.code = code.value; const rm = el('button', 'btn', 'åˆªé™¤'); rm.onclick = () => { arr.splice(i, 1); renderCardList(sel, arr) }; card.appendChild(title); card.appendChild(code); card.appendChild(rm); box.appendChild(card); }); }

        $('#btnEditor').onclick = openEditor; $('#btnClose').onclick = closeEditor; $('#btnDefault').onclick = () => { cfg = JSON.parse(JSON.stringify(DEFAULT)); openEditor(); }
        $('#addTile').onclick = () => { cfg.tiles.push({ t: 'æ–°æ ¼å­', type: 'normal', desc: '' }); renderTileTable(); };
        $('#addChance').onclick = () => { cfg.chance.push({ text: 'æ–°æ©Ÿæœƒå¡', code: '' }); renderCardList('#chanceList', cfg.chance) };
        $('#addDestiny').onclick = () => { cfg.destiny.push({ text: 'æ–°å‘½é‹å¡', code: '' }); renderCardList('#destinyList', cfg.destiny) };

        // è¨­å®šåŒ¯å…¥/åŒ¯å‡º
        function exportCfg() { const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'alcohol-config.json'; a.click(); URL.revokeObjectURL(url); }
        $('#btnSaveCfg').onclick = exportCfg; $('#btnExportCfg2').onclick = exportCfg; $('#btnLoadCfg').onclick = () => $('#cfgFile').click(); $('#btnImportCfg2').onclick = () => $('#importCfg2').click();
        $('#cfgFile').onchange = e => { const f = e.target.files[0]; if (!f) return; const rd = new FileReader(); rd.onload = () => { try { cfg = JSON.parse(rd.result); buildBoard(); closeEditor(); log('å·²è¼‰å…¥è¨­å®š'); } catch { alert('JSON è§£æå¤±æ•—') } }; rd.readAsText(f) };
        $('#importCfg2').onchange = e => $('#cfgFile').onchange(e);

        // å­˜æª”
        $('#btnExportSave').onclick = e => { const save = { players: state.players.map(p => ({ name: p.name, color: p.color, pos: p.pos, sips: p.sips, totalSips: p.totalSips, skip: p.skip, buff: p.buff })), turn: state.turn, cup: state.cup, cfg, chance: state.chance, destiny: state.destiny, waitingEnd: state.waitingEnd }; const blob = new Blob([JSON.stringify(save, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); e.target.href = url; e.target.download = 'alcohol-monopoly-save.json'; };
        $('#btnImportSave').onclick = () => $('#importSave').click();
        $('#importSave').onchange = ev => { const f = ev.target.files[0]; if (!f) return; const rd = new FileReader(); rd.onload = () => { try { const data = JSON.parse(rd.result); cfg = data.cfg || cfg; state.players = []; (data.players || []).forEach(p => addPlayer(p.name)); state.players.forEach((p, i) => { const d = data.players[i]; p.pos = d.pos; p.sips = d.sips || 0; p.totalSips = d.totalSips || 0; p.skip = d.skip || false; p.buff = d.buff || 0; }); state.turn = data.turn || 0; state.cup = data.cup || 0; state.chance = data.chance || []; state.destiny = data.destiny || []; state.waitingEnd = !!data.waitingEnd; buildBoard(); placePawns(); renderPlayers(); refreshTurnInfo(); updateControls(); log('å·²è¼‰å…¥å­˜æª”'); } catch (err) { alert('è¼‰å…¥å¤±æ•—') } }; rd.readAsText(f) };

        // å›ä¸Šä¸€æ­¥ï¼ˆUndoï¼‰
        function pushSnapshot() { const snap = { turn: state.turn, cup: state.cup, waitingEnd: state.waitingEnd, chance: JSON.parse(JSON.stringify(state.chance)), destiny: JSON.parse(JSON.stringify(state.destiny)), players: state.players.map(p => ({ name: p.name, color: p.color, pos: p.pos, sips: p.sips, totalSips: p.totalSips, skip: p.skip, buff: p.buff })) }; history.push(snap); updateControls(); }
        function undo() { if (history.length === 0) return; const s = history.pop(); state.turn = s.turn; state.cup = s.cup; state.waitingEnd = s.waitingEnd; state.chance = s.chance; state.destiny = s.destiny; state.players.forEach((p, i) => { const d = s.players[i]; if (!d) return; p.pos = d.pos; p.sips = d.sips; p.totalSips = d.totalSips; p.skip = d.skip; p.buff = d.buff; }); $('#cup').textContent = state.cup; placePawns(); renderPlayers(); refreshTurnInfo(); updateControls(); log('å·²å›å¾©åˆ°ä¸Šä¸€æ­¥'); }
        $('#undoBtn').onclick = undo;

        // å…¶å®ƒ UI
        $('#addPlayer').onclick = () => { addPlayer($('#playerName').value.trim()); $('#playerName').value = ''; };
        $('#quick2').onclick = () => { ['ç©å®¶1', 'ç©å®¶2'].forEach(addPlayer) };
        $('#quick4').onclick = () => { ['ç©å®¶1', 'ç©å®¶2', 'ç©å®¶3', 'ç©å®¶4'].forEach(addPlayer) };
        $('#roll').onclick = roll; $('#endTurn').onclick = nextTurn;
        $('#btnReset').onclick = () => { if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿ')) location.reload(); };
        $('#btnHow').onclick = () => { alert('ç©æ³•é€Ÿè¦½\n\n1) æ–°å¢ 2~20 ä½ç©å®¶\n2) å¯å…ˆç”¨ã€Œæª¢è¦–/ç·¨è¼¯ã€èª¿æ•´æ‰€æœ‰æ ¼å­èˆ‡å¡ç‰Œ\n3) æ“²éª°æ™‚æœƒæ’­æ”¾å‹•ç•«ï¼›åœæ ¼æœƒç¿»å¡é¡¯ç¤ºè©³ç´°è¦å‰‡\n4) å•Ÿç”¨ã€Œè‡ªå‹•æ›äººã€å¯åœ¨è¡Œå‹•å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€ä½ï¼›è‹¥æœªå•Ÿç”¨ï¼Œç³»çµ±æœƒé–ä½æ“²éª°ç›´åˆ°æŒ‰ä¸‹ã€ŒçµæŸå›åˆã€ï¼Œé¿å…æœ‰äººé€£çºŒèµ°å…©è¼ª\n5) å¯ç”¨ã€Œå›ä¸Šä¸€æ­¥ã€å¾©åŸä¸Šä¸€æ¬¡æ“²éª°/è¡Œå‹•'); };

        function log(t) { const it = el('div', 'item', new Date().toLocaleTimeString() + ' Â· ' + t); $('#log').prepend(it) }
        function updateControls() { $('#roll').disabled = state.waitingEnd || state.anim || state.moving || state.players.length === 0; $('#endTurn').disabled = !state.waitingEnd || state.players.length === 0; $('#undoBtn').disabled = history.length === 0; }

        function init() { buildBoard(); $('#chancePeek').textContent = `${DEFAULT.chance.length} å¼µï¼ˆæ´—ç‰Œå¾ŒæŠ½å–ï¼‰`; $('#destinyPeek').textContent = `${DEFAULT.destiny.length} å¼µï¼ˆæ´—ç‰Œå¾ŒæŠ½å–ï¼‰`; refreshTurnInfo(); updateControls(); log('v4 å·²å•Ÿç”¨ï¼šå›åˆé˜²å‘†ï¼‹è‡ªå‹•æ›äººï¼‹å›ä¸Šä¸€æ­¥'); }
        init();
    </script>
</body>

</html>